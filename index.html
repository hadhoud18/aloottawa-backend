
<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AloOttawa Deals - Mobile</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Stripe SDK -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Leaflet CSS for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', 'Segoe UI', system-ui, -apple-system, sans-serif;
            transition: all 0.3s ease;
        }
        
        :root {
            --primary-blue: #0984e3;
            --primary-gradient: linear-gradient(135deg, #74b9ff, #0984e3);
            --success-green: #00b894;
            --warning-yellow: #fdcb6e;
            --danger-red: #d63031;
            --dark-gray: #2d3436;
            --medium-gray: #636e72;
            --light-gray: #f8f9fa;
            --card-bg: #ffffff;
            --arabic-gold: #D4AF37;
            --arabic-green: #006B36;
            --arabic-blue: #005A8C;
            --arabic-red: #C41E3A;
            --entertainment-purple: #9b59b6;
            --selfcare-pink: #fd79a8;
            --restaurant-red: #e74c3c;
            --supermarket-green: #27ae60;
            --savings-teal: #008080;
            --subscription-indigo: #4834d4;
            --stripe-purple: #6772e5;
            --stripe-dark: #32325d;
        }
        
        body {
            background-color: var(--light-gray);
            color: var(--dark-gray);
            max-width: 500px;
            margin: 0 auto;
            min-height: 100vh;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.08);
            position: relative;
            overflow-x: hidden;
        }
        
        /* RTL Support */
        body[dir="rtl"] {
            text-align: right;
        }
        
        body[dir="rtl"] .d-flex {
            flex-direction: row-reverse;
        }
        
        body[dir="rtl"] .text-start {
            text-align: right !important;
        }
        
        body[dir="rtl"] .text-end {
            text-align: left !important;
        }
        
        body[dir="rtl"] .me-2 {
            margin-right: 0 !important;
            margin-left: 0.5rem !important;
        }
        
        body[dir="rtl"] .ms-2 {
            margin-left: 0 !important;
            margin-right: 0.5rem !important;
        }
        
        body[dir="rtl"] .me-3 {
            margin-right: 0 !important;
            margin-left: 1rem !important;
        }
        
        body[dir="rtl"] .ms-3 {
            margin-left: 0 !important;
            margin-right: 1rem !important;
        }
        
        .arabic-font {
            font-family: 'Cairo', sans-serif !important;
        }
        
        .english-font {
            font-family: 'Poppins', sans-serif !important;
        }
        
        .text-arabic {
            font-family: 'Cairo', sans-serif;
            display: none;
        }
        
        .text-english {
            font-family: 'Poppins', sans-serif;
            display: block;
        }
        
        .text-french {
            font-family: 'Poppins', sans-serif;
            display: none;
        }
        
        body[lang="ar"] .text-arabic {
            display: block;
        }
        
        body[lang="ar"] .text-english,
        body[lang="ar"] .text-french {
            display: none;
        }
        
        body[lang="fr"] .text-french {
            display: block;
        }
        
        body[lang="fr"] .text-english,
        body[lang="fr"] .text-arabic {
            display: none;
        }
        
        /* Status Bar */
        .status-bar {
            display: flex;
            justify-content: space-between;
            padding: 12px 16px 6px;
            background-color: #fff;
            border-bottom: 1px solid #f0f0f0;
            font-size: 15px;
            font-weight: 500;
            color: var(--dark-gray);
        }
        
        .time-left {
            color: var(--dark-gray);
        }
        
        .time-right {
            color: var(--medium-gray);
        }
        
        /* Main Container */
        .container {
            padding: 0 16px 90px;
            background-color: #fff;
            min-height: calc(100vh - 80px);
        }
        
        /* Header Section */
        .header-section {
            padding: 20px 0 15px;
            border-bottom: 1px solid #f0f0f0;
            margin-bottom: 20px;
        }
        
        .greeting {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark-gray);
            margin-bottom: 5px;
        }
        
        .question {
            font-size: 16px;
            color: var(--medium-gray);
            font-weight: 500;
            margin-bottom: 15px;
        }
        
        /* Location Section */
        .location-section {
            background: linear-gradient(135deg, rgba(116, 185, 255, 0.1), rgba(9, 132, 227, 0.1));
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(9, 132, 227, 0.2);
        }
        
        .location-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .location-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--arabic-blue);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .location-btn {
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .location-status {
            font-size: 14px;
            color: var(--medium-gray);
        }
        
        .location-status.success {
            color: var(--success-green);
            font-weight: 600;
        }
        
        /* Categories Section */
        .categories-section {
            margin-bottom: 25px;
        }
        
        .categories-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--dark-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .language-toggle {
            background: var(--light-gray);
            border: 2px solid var(--arabic-blue);
            color: var(--arabic-blue);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        
        .category-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 16px;
            padding: 18px 10px;
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            cursor: pointer;
        }
        
        .category-card:hover,
        .category-card.active {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.05);
            border-color: var(--primary-blue);
        }
        
        .category-card[data-category="entertainment"]:hover,
        .category-card[data-category="entertainment"].active {
            border-color: var(--entertainment-purple);
        }
        
        .category-card[data-category="selfcare"]:hover,
        .category-card[data-category="selfcare"].active {
            border-color: var(--selfcare-pink);
        }
        
        .category-card[data-category="restaurant"]:hover,
        .category-card[data-category="restaurant"].active {
            border-color: var(--restaurant-red);
        }
        
        .category-card[data-category="supermarket"]:hover,
        .category-card[data-category="supermarket"].active {
            border-color: var(--supermarket-green);
        }
        
        .category-icon {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--primary-blue);
        }
        
        .category-card[data-category="entertainment"] .category-icon {
            color: var(--entertainment-purple);
        }
        
        .category-card[data-category="selfcare"] .category-icon {
            color: var(--selfcare-pink);
        }
        
        .category-card[data-category="restaurant"] .category-icon {
            color: var(--restaurant-red);
        }
        
        .category-card[data-category="supermarket"] .category-icon {
            color: var(--supermarket-green);
        }
        
        .category-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark-gray);
        }
        
        /* Offers Section */
        .offers-section {
            margin-bottom: 25px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark-gray);
        }
        
        .view-all {
            color: var(--primary-blue);
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
        }
        
        /* DEALS GRID - 2 PER LINE */
        .deals-grid-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        /* Deal Card - Mobile Version - 2 per line */
        .deal-card-mobile {
            background: white;
            border-radius: 16px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid #f0f0f0;
            position: relative;
            overflow: hidden;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .deal-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--arabic-red);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 11px;
            z-index: 2;
        }
        
        body[dir="rtl"] .deal-badge {
            right: auto;
            left: 12px;
        }
        
        .deal-image-container {
            height: 120px;
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 12px;
            position: relative;
        }
        
        .deal-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .deal-image-container:hover .deal-image {
            transform: scale(1.05);
        }
        
        .deal-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--arabic-blue);
            margin-bottom: 6px;
            line-height: 1.3;
            min-height: 42px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .deal-store {
            font-size: 13px;
            color: var(--arabic-green);
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        body[dir="rtl"] .deal-store {
            flex-direction: row-reverse;
        }
        
        .deal-description {
            font-size: 12px;
            color: var(--medium-gray);
            margin-bottom: 10px;
            line-height: 1.4;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            flex-grow: 1;
        }
        
        .deal-price-container {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }
        
        .deal-price {
            display: flex;
            align-items: baseline;
            gap: 6px;
        }
        
        body[dir="rtl"] .deal-price {
            flex-direction: row-reverse;
        }
        
        .old-price {
            text-decoration: line-through;
            color: #999;
            font-size: 13px;
        }
        
        .new-price {
            color: var(--arabic-red);
            font-size: 18px;
            font-weight: bold;
        }
        
        .deal-distance {
            font-size: 11px;
            color: var(--medium-gray);
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 3px;
        }
        
        .deal-actions {
            display: flex;
            gap: 8px;
            margin-top: auto;
        }
        
        body[dir="rtl"] .deal-actions {
            flex-direction: row-reverse;
        }
        
        .redeem-btn {
            flex: 1;
            background: var(--arabic-red);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s ease;
        }
        
        .redeem-btn:hover {
            background: #b91c1c;
            transform: translateY(-2px);
        }
        
        body[dir="rtl"] .redeem-btn {
            flex-direction: row-reverse;
        }
        
        .details-btn {
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .details-btn:hover {
            background: #0a7ae6;
            transform: translateY(-2px);
        }
        
        .halal-badge {
            background: var(--arabic-green);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 10px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-top: 8px;
            align-self: flex-start;
        }
        
        body[dir="rtl"] .halal-badge {
            flex-direction: row-reverse;
        }
        
        .deal-card-mobile .category-badge {
            position: absolute;
            top: 12px;
            left: 12px;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 9px;
            font-weight: bold;
            z-index: 2;
        }
        
        body[dir="rtl"] .deal-card-mobile .category-badge {
            left: auto;
            right: 12px;
        }
        
        .entertainment-badge {
            background: var(--entertainment-purple);
            color: white;
        }
        
        .selfcare-badge {
            background: var(--selfcare-pink);
            color: white;
        }
        
        .restaurant-badge {
            background: var(--restaurant-red);
            color: white;
        }
        
        .supermarket-badge {
            background: var(--supermarket-green);
            color: white;
        }
        
        .deal-rating {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 8px;
            font-size: 12px;
        }
        
        .rating-stars {
            color: #FFD700;
            font-size: 12px;
        }
        
        .rating-count {
            color: var(--medium-gray);
            font-size: 11px;
        }
        
        /* No Deals Message */
        .no-deals {
            text-align: center;
            padding: 40px 20px;
            background: white;
            border-radius: 18px;
            margin-top: 20px;
            grid-column: 1 / -1;
        }
        
        .no-deals i {
            font-size: 3rem;
            color: #ccc;
            margin-bottom: 15px;
        }
        
        /* Bottom Navigation - FIXED FOR ALL BROWSERS */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 500px;
            background-color: white;
            display: flex;
            justify-content: space-around;
            padding: 12px 10px;
            border-top: 1px solid #f0f0f0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.08);
            z-index: 1000;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--medium-gray);
            transition: all 0.2s ease;
            flex: 1;
            padding: 5px 0;
            border: none;
            background: none;
            cursor: pointer;
        }
        
        .nav-item.active {
            color: var(--primary-blue);
        }
        
        .nav-icon {
            font-size: 18px;
            margin-bottom: 4px;
        }
        
        .nav-text {
            font-size: 11px;
            font-weight: 500;
        }
        
        .nav-item:hover {
            color: var(--primary-blue);
            transform: translateY(-2px);
        }
        
        /* Profile Section in Header */
        .profile-section {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        body[dir="rtl"] .profile-section {
            flex-direction: row-reverse;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-blue);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }
        
        .user-info h3 {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
        }
        
        .user-info p {
            font-size: 14px;
            color: var(--medium-gray);
            margin: 0;
        }
        
        /* Login Button */
        .login-btn {
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            width: 100%;
            justify-content: center;
        }
        
        body[dir="rtl"] .login-btn {
            flex-direction: row-reverse;
        }
        
        /* UPDATED: Modal Styles - Full Screen Mobile */
        .modal-mobile {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.9);
            z-index: 2000;
            width: 100%;
            height: 100%;
            overflow: hidden;
            margin: 0;
            padding: 0;
            animation: modalFadeIn 0.3s ease;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-content-mobile {
            background: white;
            margin: 0;
            padding: 20px;
            border-radius: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            position: relative;
            display: flex;
            flex-direction: column;
            animation: modalSlideUp 0.3s ease;
        }
        
        @keyframes modalSlideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            cursor: pointer;
            color: var(--dark-gray);
            background: rgba(255,255,255,0.9);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        
        body[dir="rtl"] .close-modal {
            right: auto;
            left: 20px;
        }
        
        /* PIN Input for Mobile */
        .pin-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }
        
        .pin-input-mobile {
            width: 60px;
            height: 70px;
            text-align: center;
            font-size: 28px;
            font-weight: bold;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            transition: all 0.3s;
        }
        
        .pin-input-mobile:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 0.25rem rgba(9, 132, 227, 0.25);
            outline: none;
        }
        
        /* Rating Stars */
        .rating-stars-mobile {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            font-size: 2.5rem;
            color: #ddd;
        }
        
        .rating-star-mobile {
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .rating-star-mobile:hover,
        .rating-star-mobile.active {
            color: var(--arabic-gold);
            transform: scale(1.3);
        }
        
        /* Alert Message */
        .alert-mobile {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--dark-gray);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 500;
            z-index: 1500;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            animation: fadeInOut 3s ease;
            max-width: 90%;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; top: 40px; }
            15% { opacity: 1; top: 60px; }
            85% { opacity: 1; top: 60px; }
            100% { opacity: 0; top: 40px; }
        }
        
        /* UPDATED: Map Modal Mobile - Full Screen */
        .map-modal-mobile {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.9);
            z-index: 2000;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        
        .map-content-mobile {
            background: white;
            margin: 0;
            padding: 20px;
            border-radius: 0;
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        #storeMapMobile {
            width: 100%;
            height: 100%;
            border-radius: 12px;
            margin-top: 10px;
            flex: 1;
        }
        
        /* Search Bar */
        .search-bar {
            margin: 15px 0 20px;
        }
        
        .search-input-group {
            display: flex;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #f0f0f0;
        }
        
        .search-input {
            flex: 1;
            border: none;
            padding: 15px;
            font-size: 16px;
            outline: none;
        }
        
        .search-btn {
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 0 20px;
            cursor: pointer;
        }
        
        /* Distance Filter */
        .distance-filter {
            background: white;
            padding: 15px;
            border-radius: 16px;
            margin: 15px 0;
            border: 1px solid #f0f0f0;
        }
        
        .distance-slider-mobile {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e9ecef;
            outline: none;
            margin: 10px 0;
        }
        
        .distance-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-blue);
            text-align: center;
            margin-top: 10px;
        }
        
        /* Phone input styling */
        .phone-input-group {
            display: flex;
            gap: 10px;
        }

        .country-code {
            width: 80px;
            text-align: center;
        }

        /* OTP Section */
        .otp-section {
            display: none;
        }

        .otp-inputs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .otp-input {
            width: 50px;
            height: 60px;
            text-align: center;
            font-size: 22px;
            font-weight: bold;
            border: 2px solid #dee2e6;
            border-radius: 10px;
        }

        .otp-input:focus {
            border-color: var(--primary-blue);
            outline: none;
        }

        .resend-otp {
            text-align: center;
            margin-top: 15px;
        }

        .resend-otp a {
            color: var(--primary-blue);
            text-decoration: none;
            cursor: pointer;
        }

        .resend-otp a:hover {
            text-decoration: underline;
        }

        /* Phone verification badge */
        .phone-verified {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: var(--success-green);
            color: white;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-left: 10px;
        }

        body[dir="rtl"] .phone-verified {
            margin-left: 0;
            margin-right: 10px;
        }

        /* Demo OTP Box */
        .demo-otp-box {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .demo-otp-code {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-blue);
            letter-spacing: 3px;
            margin: 10px 0;
        }

        .demo-note {
            font-size: 12px;
            color: var(--medium-gray);
            margin-top: 10px;
        }
        
        /* Fix for Safari bottom bar */
        @supports (-webkit-touch-callout: none) {
            .bottom-nav {
                padding-bottom: 25px;
            }
        }
        
        /* Deals Count */
        .deals-count {
            font-size: 12px;
            color: var(--medium-gray);
            margin-top: 5px;
        }
        
        .sync-btn {
            background: none;
            border: none;
            color: var(--primary-blue);
            font-size: 14px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .sync-btn:hover {
            background-color: rgba(9, 132, 227, 0.1);
        }
        
        /* Sync animation */
        .syncing {
            animation: spin 1s linear infinite;
        }
        
        /* Firebase CAPTCHA Container */
        #recaptcha-container {
            margin: 20px 0;
            display: none;
        }
        
        /* Firestore loading */
        .firebase-loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
        
        /* Entertainment & Self Care specific styles */
        .deal-card-mobile.entertainment {
            border-top: 4px solid var(--entertainment-purple);
        }
        
        .deal-card-mobile.selfcare {
            border-top: 4px solid var(--selfcare-pink);
        }
        
        .deal-card-mobile.restaurant {
            border-top: 4px solid var(--restaurant-red);
        }
        
        .deal-card-mobile.supermarket {
            border-top: 4px solid var(--supermarket-green);
        }
        
        /* Store area badge */
        .store-area {
            font-size: 10px;
            color: var(--medium-gray);
            background: #f8f9fa;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
            margin-top: 5px;
        }
        
        /* View all deals button */
        .view-all-deals-btn {
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .view-all-deals-btn:hover {
            background: #0a7ae6;
            transform: translateY(-2px);
        }
        
        /* Map controls */
        .leaflet-control-container .leaflet-top {
            top: 70px !important;
        }
        
        .leaflet-control-container .leaflet-bottom {
            bottom: 70px !important;
        }
        
        /* Responsive adjustments */
        @media (max-width: 500px) {
            body {
                max-width: 100%;
            }
            
            .bottom-nav {
                max-width: 100%;
            }
            
            .modal-content-mobile {
                padding: 15px;
            }
            
            .categories-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .deals-grid-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .deal-image-container {
                height: 100px;
            }
            
            .deal-title {
                font-size: 15px;
                min-height: 38px;
            }
            
            .pin-input-mobile {
                width: 50px;
                height: 60px;
                font-size: 24px;
            }
        }
        
        @media (max-width: 350px) {
            .deals-grid-container {
                grid-template-columns: 1fr;
            }
            
            .pin-input-mobile {
                width: 45px;
                height: 55px;
                font-size: 22px;
            }
        }
        
        /* Loading Spinner */
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
            grid-column: 1 / -1;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-blue);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Form Elements RTL */
        body[dir="rtl"] .form-control {
            text-align: right;
        }
        
        body[dir="rtl"] .form-check-label {
            margin-right: 0.5rem;
            margin-left: 0;
        }
        
        body[dir="rtl"] .form-check-input {
            margin-right: 0;
            margin-left: 0.5rem;
        }
        
        body[dir="rtl"] .list-group-item {
            text-align: right;
            flex-direction: row-reverse;
        }
        
        body[dir="rtl"] .alert {
            text-align: right;
        }
        
        body[dir="rtl"] .text-center {
            text-align: center !important;
        }

        /* My Savings Card Styles - REMOVED from main view, now only in modal */
        .savings-card {
            background: linear-gradient(135deg, #008080, #005757);
            border-radius: 16px;
            padding: 16px;
            margin: 16px 0;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 6px 12px rgba(0, 128, 128, 0.2);
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .savings-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 128, 128, 0.3);
        }

        .savings-left {
            display: flex;
            flex-direction: column;
        }

        .savings-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .savings-amount {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .savings-small {
            font-size: 12px;
            opacity: 0.8;
        }

        .savings-icon {
            font-size: 42px;
            opacity: 0.8;
        }

        .savings-icon i {
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        body[dir="rtl"] .savings-card {
            flex-direction: row-reverse;
        }

        /* Savings Modal Specific */
        .savings-summary {
            background: linear-gradient(135deg, #008080, #005757);
            border-radius: 20px;
            padding: 30px 20px;
            margin: 20px 0;
            color: white;
            text-align: center;
        }

        .savings-big-number {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .savings-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin: 20px 0;
        }

        .savings-stat-card {
            background: var(--light-gray);
            border-radius: 16px;
            padding: 16px;
            text-align: center;
        }

        .savings-stat-icon {
            font-size: 24px;
            color: var(--savings-teal);
            margin-bottom: 10px;
        }

        .savings-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark-gray);
        }

        .savings-stat-label {
            font-size: 13px;
            color: var(--medium-gray);
            margin-top: 5px;
        }

        .savings-timeline {
            margin: 20px 0;
        }

        .timeline-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .timeline-item:last-child {
            border-bottom: none;
        }

        .timeline-date {
            color: var(--medium-gray);
            font-size: 14px;
        }

        .timeline-deal {
            font-weight: 600;
            color: var(--dark-gray);
        }

        .timeline-saved {
            color: var(--success-green);
            font-weight: 600;
        }
        
        /* Hide savings card from main view - REMOVED */
        #savingsCardMobile {
            display: none !important;
        }

        /* ========== SUBSCRIPTION MODAL & BADGE STYLES - STRIPE PAYMENT ========== */
        .subscription-badge {
            background: var(--subscription-indigo);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 8px;
        }

        .subscription-card {
            background: linear-gradient(135deg, #4834d4, #30336b);
            border-radius: 16px;
            padding: 20px;
            color: white;
            margin-bottom: 20px;
        }

        .subscription-plan {
            background: var(--light-gray);
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid var(--subscription-indigo);
            position: relative;
        }

        .plan-popular {
            position: absolute;
            top: -12px;
            right: 20px;
            background: var(--arabic-red);
            color: white;
            padding: 4px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        body[dir="rtl"] .plan-popular {
            right: auto;
            left: 20px;
        }

        /* Stripe Elements styling */
        .stripe-card-element {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .stripe-card-element.StripeElement--focus {
            border-color: var(--stripe-purple);
            box-shadow: 0 0 0 3px rgba(103, 114, 229, 0.1);
        }

        .stripe-card-element.StripeElement--invalid {
            border-color: var(--danger-red);
        }

        .stripe-payment-methods {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
            background: var(--light-gray);
            border-radius: 12px;
        }

        .stripe-payment-method-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid transparent;
            border-radius: 10px;
            background: white;
            color: var(--dark-gray);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .stripe-payment-method-btn.active {
            background: var(--stripe-purple);
            color: white;
            border-color: var(--stripe-dark);
        }

        .stripe-payment-method-btn i {
            font-size: 20px;
        }

        .pricing {
            font-size: 36px;
            font-weight: 700;
            color: var(--subscription-indigo);
        }

        .pricing small {
            font-size: 16px;
            font-weight: 400;
            color: var(--medium-gray);
        }

        .subscribe-btn {
            background: var(--stripe-purple);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 14px;
            font-weight: 700;
            font-size: 18px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .subscribe-btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(103, 114, 229, 0.4);
        }

        .subscribe-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .card-error-message {
            color: var(--danger-red);
            font-size: 14px;
            margin-top: 8px;
            display: none;
        }

        .card-success-message {
            color: var(--success-green);
            font-size: 14px;
            margin-top: 8px;
            display: none;
        }

        .stripe-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--medium-gray);
            font-size: 12px;
            margin-top: 16px;
            justify-content: center;
        }

        .stripe-badge i {
            color: var(--stripe-purple);
        }

        .saved-cards-list {
            margin-bottom: 20px;
        }

        .saved-card-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .saved-card-item:hover {
            border-color: var(--stripe-purple);
            background: rgba(103, 114, 229, 0.05);
        }

        .saved-card-item.selected {
            border-color: var(--stripe-purple);
            background: rgba(103, 114, 229, 0.1);
        }

        .saved-card-radio {
            margin-right: 12px;
        }

        body[dir="rtl"] .saved-card-radio {
            margin-right: 0;
            margin-left: 12px;
        }

        .saved-card-details {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .saved-card-brand {
            font-size: 24px;
        }

        .saved-card-number {
            font-weight: 600;
        }

        .saved-card-expiry {
            color: var(--medium-gray);
            font-size: 12px;
        }
    </style>
</head>
<body lang="en" dir="ltr">
    <!-- Status Bar -->
    <div class="status-bar">
        <div class="time-left" id="timeLeft">9:42</div>
        <div class="time-right" id="timeRight">12:58</div>
    </div>
    
    <!-- Main Content Container -->
    <div class="container" id="mainContainer">
        <!-- Header Section -->
        <div class="header-section">
            <!-- Profile Section -->
            <div id="profileSection" style="display: none;">
                <div class="profile-section">
                    <div class="user-avatar" id="userAvatarMobile">U</div>
                    <div class="user-info">
                        <h3 id="userNameMobile">User Name</h3>
                        <p id="userEmailMobile">user@email.com</p>
                        <small id="userPhoneMobile"></small>
                    </div>
                </div>
            </div>
            
            <!-- Greeting Section -->
            <div id="greetingSection">
                <h1 class="greeting" id="greetingText">
                    <span class="text-english">Good afternoon!</span>
                    <span class="text-arabic">مساء الخير!</span>
                    <span class="text-french">Bon après-midi !</span>
                </h1>
                <p class="question" id="questionText">
                    <span class="text-english">Where will you save today?</span>
                    <span class="text-arabic">أين ستوفر اليوم؟</span>
                    <span class="text-french">Où allez-vous économiser aujourd'hui ?</span>
                </p>
            </div>
            
            <!-- Login Button -->
            <button class="login-btn" id="loginButtonMobile" onclick="openLoginModal()">
                <i class="fas fa-user"></i>
                <span class="text-english">Login / Sign Up</span>
                <span class="text-arabic">تسجيل الدخول / إنشاء حساب</span>
                <span class="text-french">Connexion / Inscription</span>
            </button>
        </div>
        
        <!-- MY SAVINGS CARD - REMOVED FROM MAIN VIEW as requested (now only accessible via Profile -> My Redeemed Deals) -->
        <!-- The savings card div is hidden via CSS (display: none !important) -->
        <div class="savings-card" id="savingsCardMobile" onclick="openMySavingsModal()" style="display: none;">
            <div class="savings-left">
                <span class="savings-label">
                    <span class="text-english">My Savings This Month</span>
                    <span class="text-arabic">مدخراتي هذا الشهر</span>
                    <span class="text-french">Mes économies ce mois-ci</span>
                </span>
                <span class="savings-amount" id="totalSavingsAmountMobile">$0.00</span>
                <span class="savings-small">
                    <span class="text-english">This month's savings with AloOttawa</span>
                    <span class="text-arabic">مدخرات هذا الشهر مع AloOttawa</span>
                    <span class="text-french">Économies de ce mois-ci avec AloOttawa</span>
                </span>
            </div>
            <div class="savings-icon">
                <i class="fas fa-piggy-bank"></i>
            </div>
        </div>
        
        <!-- Search Bar -->
        <div class="search-bar">
            <div class="search-input-group">
                <input type="text" class="search-input" id="searchInputMobile" 
                       placeholder="Search for deals or stores..." 
                       data-placeholder-en="Search for deals or stores..."
                       data-placeholder-ar="ابحث عن عروض أو متاجر..."
                       data-placeholder-fr="Rechercher des offres ou des magasins...">
                <button class="search-btn" onclick="searchDealsMobile()">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
        
        <!-- Location Section -->
        <div class="location-section">
            <div class="location-header">
                <div class="location-title">
                    <i class="fas fa-map-marker-alt"></i>
                    <span class="text-english">Nearby Deals</span>
                    <span class="text-arabic">عروض قريبة</span>
                    <span class="text-french">Offres à proximité</span>
                </div>
                <button class="location-btn" onclick="getUserLocationMobile()">
                    <i class="fas fa-location-crosshairs"></i>
                    <span class="text-english">Locate</span>
                    <span class="text-arabic">تحديد الموقع</span>
                    <span class="text-french">Localiser</span>
                </button>
            </div>
            <div class="location-status" id="locationStatusMobile">
                <span class="text-english">Click "Locate" to find deals near you</span>
                <span class="text-arabic">انقر على "تحديد الموقع" للعثور على عروض قريبة منك</span>
                <span class="text-french">Cliquez sur "Localiser" pour trouver des offres près de vous</span>
            </div>
            
            <!-- Distance Filter -->
            <div class="distance-filter" id="distanceFilterMobile" style="display: none;">
                <div class="d-flex justify-content-between">
                    <span>
                        <span class="text-english">Search Radius:</span>
                        <span class="text-arabic">نصف قطر البحث:</span>
                        <span class="text-french">Rayon de recherche:</span>
                    </span>
                    <span class="distance-value" id="distanceValueMobile">5 km</span>
                </div>
                <input type="range" class="distance-slider-mobile" id="distanceSliderMobile" 
                       min="1" max="50" value="5" step="1" oninput="updateDistanceValueMobile()">
                <div class="d-flex justify-content-between mt-2">
                    <small class="text-english">1 km</small>
                    <small class="text-arabic">1 كم</small>
                    <small class="text-french">1 km</small>
                    <small class="text-english">50 km</small>
                    <small class="text-arabic">50 كم</small>
                    <small class="text-french">50 km</small>
                </div>
            </div>
        </div>
        
        <!-- Categories Section -->
        <div class="categories-section">
            <div class="categories-title">
                <span>
                    <span class="text-english">Categories</span>
                    <span class="text-arabic">التصنيفات</span>
                    <span class="text-french">Catégories</span>
                </span>
                <button class="language-toggle" id="languageToggleMobile" onclick="toggleLanguageMobile()">
                    <span class="text-english">العربية</span>
                    <span class="text-arabic">Français</span>
                    <span class="text-french">English</span>
                </button>
            </div>
            <div class="categories-grid">
                <div class="category-card active" data-category="all" onclick="filterDealsMobile('all')">
                    <div class="category-icon">
                        <i class="fas fa-fire"></i>
                    </div>
                    <div class="category-name">
                        <span class="text-english">All Deals</span>
                        <span class="text-arabic">كل العروض</span>
                        <span class="text-french">Toutes les offres</span>
                    </div>
                </div>
                
                <div class="category-card" data-category="restaurant" onclick="filterDealsMobile('restaurant')">
                    <div class="category-icon">
                        <i class="fas fa-utensils"></i>
                    </div>
                    <div class="category-name">
                        <span class="text-english">Restaurants</span>
                        <span class="text-arabic">مطاعم</span>
                        <span class="text-french">Restaurants</span>
                    </div>
                </div>
                
                <div class="category-card" data-category="supermarket" onclick="filterDealsMobile('supermarket')">
                    <div class="category-icon">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <div class="category-name">
                        <span class="text-english">Supermarkets</span>
                        <span class="text-arabic">سوبرماركت</span>
                        <span class="text-french">Supermarchés</span>
                    </div>
                </div>
                
                <!-- New: Entertainment Category -->
                <div class="category-card" data-category="entertainment" onclick="filterDealsMobile('entertainment')">
                    <div class="category-icon">
                        <i class="fas fa-film"></i>
                    </div>
                    <div class="category-name">
                        <span class="text-english">Entertainment</span>
                        <span class="text-arabic">ترفيه</span>
                        <span class="text-french">Divertissement</span>
                    </div>
                </div>
                
                <!-- New: Self Care Category -->
                <div class="category-card" data-category="selfcare" onclick="filterDealsMobile('selfcare')">
                    <div class="category-icon">
                        <i class="fas fa-spa"></i>
                    </div>
                    <div class="category-name">
                        <span class="text-english">Self Care</span>
                        <span class="text-arabic">العناية الذاتية</span>
                        <span class="text-french">Soins personnels</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Offers Section -->
        <div class="offers-section">
            <div class="section-header">
                <div>
                    <h2 class="section-title">
                        <span class="text-english">Today's Best Deals</span>
                        <span class="text-arabic">أفضل العروض اليوم</span>
                        <span class="text-french">Meilleures offres du jour</span>
                    </h2>
                    <small class="text-muted deals-count" id="dealsCount">
                        <span class="text-english">Loading deals...</span>
                        <span class="text-arabic">جاري تحميل العروض...</span>
                        <span class="text-french">Chargement des offres...</span>
                    </small>
                </div>
                <div>
                    <a href="#" class="view-all me-2" onclick="viewAllDeals()">
                        <span class="text-english">VIEW ALL</span>
                        <span class="text-arabic">عرض الكل</span>
                        <span class="text-french">VOIR TOUT</span>
                    </a>
                    <button class="sync-btn" onclick="syncWithStoreDeals()" title="Sync with store dashboard">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            
            <!-- Deals Grid Container -->
            <div class="deals-grid-container" id="dealsContainerMobile">
                <!-- Deals will be loaded here in 2-per-line grid -->
                <div class="loading-spinner" id="loadingSpinner">
                    <div class="spinner"></div>
                    <p class="mt-2 text-english">Loading deals...</p>
                    <p class="mt-2 text-arabic">جاري تحميل العروض...</p>
                    <p class="mt-2 text-french">Chargement des offres...</p>
                </div>
            </div>
            
            <!-- View All Deals Button -->
            <button class="view-all-deals-btn" id="viewAllDealsBtn" style="display: none;" onclick="viewAllDeals()">
                <i class="fas fa-eye"></i>
                <span class="text-english">View All Deals</span>
                <span class="text-arabic">عرض جميع العروض</span>
                <span class="text-french">Voir toutes les offres</span>
            </button>
            
            <!-- No Deals Message -->
            <div id="noDealsMessageMobile" class="no-deals" style="display: none;">
                <i class="fas fa-gift"></i>
                <h3 class="text-english">No deals available</h3>
                <h3 class="text-arabic">لا توجد عروض متاحة</h3>
                <h3 class="text-french">Aucune offre disponible</h3>
                <p class="text-english">Try refreshing or check back later</p>
                <p class="text-arabic">حاول تحديث الصفحة أو عد لاحقاً</p>
                <p class="text-french">Essayez d'actualiser ou revenez plus tard</p>
                <button class="redeem-btn mt-3" onclick="loadDealsMobile()">
                    <i class="fas fa-sync-alt"></i>
                    <span class="text-english">Refresh</span>
                    <span class="text-arabic">تحديث</span>
                    <span class="text-french">Actualiser</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <button class="nav-item active" onclick="showHome()">
            <i class="fas fa-home nav-icon"></i>
            <span class="nav-text">
                <span class="text-english">Home</span>
                <span class="text-arabic">الرئيسية</span>
                <span class="text-french">Accueil</span>
            </span>
        </button>
        <button class="nav-item" onclick="openMapModal()">
            <i class="fas fa-map nav-icon"></i>
            <span class="nav-text">
                <span class="text-english">Map</span>
                <span class="text-arabic">الخريطة</span>
                <span class="text-french">Carte</span>
            </span>
        </button>
        <button class="nav-item" onclick="showMyDeals()">
            <i class="fas fa-ticket-alt nav-icon"></i>
            <span class="nav-text">
                <span class="text-english">My Deals</span>
                <span class="text-arabic">عروضي</span>
                <span class="text-french">Mes offres</span>
            </span>
        </button>
        <button class="nav-item" onclick="showSaved()">
            <i class="fas fa-bookmark nav-icon"></i>
            <span class="nav-text">
                <span class="text-english">Saved</span>
                <span class="text-arabic">المحفوظة</span>
                <span class="text-french">Enregistrées</span>
            </span>
        </button>
        <button class="nav-item" onclick="showProfile()">
            <i class="fas fa-user nav-icon"></i>
            <span class="nav-text">
                <span class="text-english">Profile</span>
                <span class="text-arabic">الملف</span>
                <span class="text-french">Profil</span>
            </span>
        </button>
    </nav>

    <!-- Login Modal -->
    <div id="loginModalMobile" class="modal-mobile">
        <div class="modal-content-mobile">
            <span class="close-modal" onclick="closeLoginModalMobile()">&times;</span>
            
            <h4 class="text-center mb-4">
                <span class="text-english">Login / Sign Up</span>
                <span class="text-arabic">تسجيل الدخول / إنشاء حساب</span>
                <span class="text-french">Connexion / Inscription</span>
            </h4>
            
            <!-- Firebase CAPTCHA Container -->
            <div id="recaptcha-container"></div>
            
            <!-- Login Tab -->
            <div id="loginTabMobile">
                <div class="mb-3">
                    <label class="form-label text-english">Email</label>
                    <label class="form-label text-arabic">البريد الإلكتروني</label>
                    <label class="form-label text-french">Email</label>
                    <input type="email" class="form-control" id="loginEmailMobile" 
                           placeholder="email@example.com" 
                           data-placeholder-en="email@example.com"
                           data-placeholder-ar="email@example.com"
                           data-placeholder-fr="email@example.com">
                </div>
                <div class="mb-3">
                    <label class="form-label text-english">Password</label>
                    <label class="form-label text-arabic">كلمة المرور</label>
                    <label class="form-label text-french">Mot de passe</label>
                    <input type="password" class="form-control" id="loginPasswordMobile" 
                           placeholder="Enter password"
                           data-placeholder-en="Enter password"
                           data-placeholder-ar="أدخل كلمة المرور"
                           data-placeholder-fr="Entrez le mot de passe">
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="rememberMeMobile">
                    <label class="form-check-label text-english" for="rememberMeMobile">Remember me</label>
                    <label class="form-check-label text-arabic" for="rememberMeMobile">تذكرني</label>
                    <label class="form-check-label text-french" for="rememberMeMobile">Se souvenir de moi</label>
                </div>
                <div class="mb-3">
                    <a href="#" class="text-primary" onclick="showForgotPasswordMobile()">
                        <span class="text-english">Forgot password?</span>
                        <span class="text-arabic">نسيت كلمة المرور؟</span>
                        <span class="text-french">Mot de passe oublié ?</span>
                    </a>
                </div>
                <div id="loginErrorMessageMobile" class="alert alert-danger d-none"></div>
                <button class="btn btn-primary w-100 mb-3" onclick="loginUserMobile()">
                    <i class="fas fa-sign-in-alt"></i>
                    <span class="text-english">Login</span>
                    <span class="text-arabic">تسجيل الدخول</span>
                    <span class="text-french">Connexion</span>
                </button>
                <div class="text-center">
                    <small class="text-english">Don't have an account? <a href="#" class="text-primary" onclick="showSignupTabMobile()">Sign up</a></small>
                    <small class="text-arabic">ليس لديك حساب؟ <a href="#" class="text-primary" onclick="showSignupTabMobile()">أنشئ حساب جديد</a></small>
                    <small class="text-french">Vous n'avez pas de compte ? <a href="#" class="text-primary" onclick="showSignupTabMobile()">Inscrivez-vous</a></small>
                </div>
            </div>
            
            <!-- Signup Tab -->
            <div id="signupTabMobile" style="display: none;">
                <div class="mb-3">
                    <label class="form-label text-english">Full Name</label>
                    <label class="form-label text-arabic">الاسم الكامل</label>
                    <label class="form-label text-french">Nom complet</label>
                    <input type="text" class="form-control" id="signupNameMobile" 
                           placeholder="Your full name"
                           data-placeholder-en="Your full name"
                           data-placeholder-ar="الاسم الكامل"
                           data-placeholder-fr="Votre nom complet">
                </div>
                <div class="mb-3">
                    <label class="form-label text-english">Email Address *</label>
                    <label class="form-label text-arabic">البريد الإلكتروني *</label>
                    <label class="form-label text-french">Adresse email *</label>
                    <input type="email" class="form-control" id="signupEmailMobile" 
                           placeholder="example@email.com"
                           data-placeholder-en="example@email.com"
                           data-placeholder-ar="example@email.com"
                           data-placeholder-fr="example@email.com">
                </div>
                <div class="mb-3">
                    <label class="form-label text-english">Mobile Number (Optional)</label>
                    <label class="form-label text-arabic">رقم الجوال (اختياري)</label>
                    <label class="form-label text-french">Numéro de mobile (optionnel)</label>
                    <div class="phone-input-group">
                        <select class="form-control country-code" id="signupCountryCodeMobile">
                            <option value="+1">+1 (CA/US)</option>
                            <option value="+966">+966 (SA)</option>
                            <option value="+971">+971 (UAE)</option>
                            <option value="+20">+20 (EG)</option>
                            <option value="+33">+33 (FR)</option>
                        </select>
                        <input type="tel" class="form-control" id="signupPhoneMobile" 
                               placeholder="6131234567"
                               data-placeholder-en="6131234567"
                               data-placeholder-ar="6131234567"
                               data-placeholder-fr="6131234567"
                               maxlength="15">
                    </div>
                    <small class="text-muted text-english">Will be used for phone verification later</small>
                    <small class="text-muted text-arabic">سيتم استخدامه للتحقق من الهاتف لاحقاً</small>
                    <small class="text-muted text-french">Sera utilisé pour la vérification téléphonique ultérieure</small>
                </div>
                <div class="mb-3">
                    <label class="form-label text-english">Password</label>
                    <label class="form-label text-arabic">كلمة المرور</label>
                    <label class="form-label text-french">Mot de passe</label>
                    <input type="password" class="form-control" id="signupPasswordMobile" 
                           placeholder="Create password"
                           data-placeholder-en="Create password"
                           data-placeholder-ar="أنشئ كلمة مرور"
                           data-placeholder-fr="Créez un mot de passe">
                </div>
                <div class="mb-3">
                    <label class="form-label text-english">Confirm Password</label>
                    <label class="form-label text-arabic">تأكيد كلمة المرور</label>
                    <label class="form-label text-french">Confirmer le mot de passe</label>
                    <input type="password" class="form-control" id="signupConfirmPasswordMobile" 
                           placeholder="Confirm password"
                           data-placeholder-en="Confirm password"
                           data-placeholder-ar="تأكيد كلمة المرور"
                           data-placeholder-fr="Confirmez le mot de passe">
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="agreeTermsMobile" required>
                    <label class="form-check-label text-english" for="agreeTermsMobile">
                        I agree to the <a href="#" class="text-primary">Terms & Conditions</a>
                    </label>
                    <label class="form-check-label text-arabic" for="agreeTermsMobile">
                        أوافق على <a href="#" class="text-primary">الشروط والأحكام</a>
                    </label>
                    <label class="form-check-label text-french" for="agreeTermsMobile">
                        J'accepte les <a href="#" class="text-primary">Conditions générales</a>
                    </label>
                </div>
                <div id="signupErrorMessageMobile" class="alert alert-danger d-none"></div>
                <button class="btn btn-success w-100 mb-3" onclick="signupUserMobile()">
                    <i class="fas fa-user-plus"></i>
                    <span class="text-english">Create Account</span>
                    <span class="text-arabic">إنشاء حساب</span>
                    <span class="text-french">Créer un compte</span>
                </button>
                <div class="text-center">
                    <small class="text-english">Already have an account? <a href="#" class="text-primary" onclick="showLoginTabMobile()">Login</a></small>
                    <small class="text-arabic">لديك حساب بالفعل؟ <a href="#" class="text-primary" onclick="showLoginTabMobile()">تسجيل الدخول</a></small>
                    <small class="text-french">Vous avez déjà un compte ? <a href="#" class="text-primary" onclick="showLoginTabMobile()">Connexion</a></small>
                </div>
            </div>

            <!-- Forgot Password Tab -->
            <div id="forgotPasswordTabMobile" style="display: none;">
                <div class="text-center mb-4">
                    <h5 class="text-english">Reset Password</h5>
                    <h5 class="text-arabic">إعادة تعيين كلمة المرور</h5>
                    <h5 class="text-french">Réinitialiser le mot de passe</h5>
                    <p class="text-muted text-english">Enter your email to receive a password reset link</p>
                    <p class="text-muted text-arabic">أدخل بريدك الإلكتروني لتلقي رابط إعادة تعيين كلمة المرور</p>
                    <p class="text-muted text-french">Entrez votre email pour recevoir un lien de réinitialisation</p>
                </div>
                <div class="mb-3">
                    <label class="form-label text-english">Email Address</label>
                    <label class="form-label text-arabic">البريد الإلكتروني</label>
                    <label class="form-label text-french">Adresse email</label>
                    <input type="email" class="form-control" id="forgotPasswordEmailMobile" 
                           placeholder="your@email.com"
                           data-placeholder-en="your@email.com"
                           data-placeholder-ar="your@email.com"
                           data-placeholder-fr="your@email.com">
                </div>
                <div id="forgotPasswordErrorMessageMobile" class="alert alert-danger d-none"></div>
                <div id="forgotPasswordSuccessMessageMobile" class="alert alert-success d-none"></div>
                <button class="btn btn-primary w-100 mb-3" onclick="resetPasswordMobile()">
                    <i class="fas fa-key"></i>
                    <span class="text-english">Send Reset Link</span>
                    <span class="text-arabic">إرسال رابط إعادة التعيين</span>
                    <span class="text-french">Envoyer le lien de réinitialisation</span>
                </button>
                <div class="text-center">
                    <small class="text-english">Remember your password? <a href="#" class="text-primary" onclick="showLoginTabMobile()">Back to Login</a></small>
                    <small class="text-arabic">تذكرت كلمة المرور؟ <a href="#" class="text-primary" onclick="showLoginTabMobile()">العودة لتسجيل الدخول</a></small>
                    <small class="text-french">Vous vous souvenez de votre mot de passe ? <a href="#" class="text-primary" onclick="showLoginTabMobile()">Retour à la connexion</a></small>
                </div>
            </div>

            <!-- Phone Login Tab -->
            <div id="phoneLoginTabMobile" style="display: none;">
                <div class="text-center mb-4">
                    <h5 class="text-english">Phone Login</h5>
                    <h5 class="text-arabic">تسجيل الدخول بالهاتف</h5>
                    <h5 class="text-french">Connexion par téléphone</h5>
                    <p class="text-muted text-english">Enter your phone number to receive OTP</p>
                    <p class="text-muted text-arabic">أدخل رقم هاتفك لتلقي رمز التحقق</p>
                    <p class="text-muted text-french">Entrez votre numéro de téléphone pour recevoir l'OTP</p>
                </div>
                <div class="mb-3">
                    <label class="form-label text-english">Mobile Number *</label>
                    <label class="form-label text-arabic">رقم الجوال *</label>
                    <label class="form-label text-french">Numéro de mobile *</label>
                    <div class="phone-input-group">
                        <select class="form-control country-code" id="phoneLoginCountryCodeMobile">
                            <option value="+1">+1 (CA/US)</option>
                            <option value="+966">+966 (SA)</option>
                            <option value="+971">+971 (UAE)</option>
                            <option value="+20">+20 (EG)</option>
                            <option value="+33">+33 (FR)</option>
                        </select>
                        <input type="tel" class="form-control" id="phoneLoginNumberMobile" 
                               placeholder="6131234567"
                               data-placeholder-en="6131234567"
                               data-placeholder-ar="6131234567"
                               data-placeholder-fr="6131234567"
                               maxlength="15">
                    </div>
                </div>
                <div id="phoneLoginErrorMessageMobile" class="alert alert-danger d-none"></div>
                <button class="btn btn-primary w-100 mb-3" onclick="sendPhoneOTPMobile()">
                    <i class="fas fa-mobile-alt"></i>
                    <span class="text-english">Send OTP</span>
                    <span class="text-arabic">إرسال رمز التحقق</span>
                    <span class="text-french">Envoyer l'OTP</span>
                </button>
                <div class="text-center">
                    <small class="text-english">Prefer email login? <a href="#" class="text-primary" onclick="showLoginTabMobile()">Use Email</a></small>
                    <small class="text-arabic">تفضل تسجيل الدخول بالبريد؟ <a href="#" class="text-primary" onclick="showLoginTabMobile()">استخدام البريد</a></small>
                    <small class="text-french">Vous préférez la connexion par email ? <a href="#" class="text-primary" onclick="showLoginTabMobile()">Utiliser l'email</a></small>
                </div>
            </div>
        </div>
    </div>

    <!-- Redeem Modal -->
    <div id="redeemModalMobile" class="modal-mobile">
        <div class="modal-content-mobile">
            <span class="close-modal" onclick="closeRedeemModalMobile()">&times;</span>
            
            <h4 class="text-center mb-4">
                <span class="text-english">Redeem Deal</span>
                <span class="text-arabic">استبدال العرض</span>
                <span class="text-french">Utiliser l'offre</span>
            </h4>
            
            <div class="text-center mb-4">
                <h5 id="redeemDealNameMobile"></h5>
                <p class="text-muted" id="redeemStoreNameMobile"></p>
            </div>
            
            <!-- Step 1: PIN Entry -->
            <div id="redeemStep1Mobile">
                <p class="text-center mb-4 text-english">Store employee must enter PIN:</p>
                <p class="text-center mb-4 text-arabic">يجب على موظف المتجر إدخال رمز PIN:</p>
                <p class="text-center mb-4 text-french">L'employé du magasin doit entrer le code PIN :</p>
                
                <div class="pin-container">
                    <input type="tel" class="pin-input-mobile" maxlength="1" pattern="[0-9]" 
                           oninput="moveToNextMobile(this, 2)" onkeydown="handlePinBackspaceMobile(event, 1)">
                    <input type="tel" class="pin-input-mobile" maxlength="1" pattern="[0-9]" 
                           oninput="moveToNextMobile(this, 3)" onkeydown="handlePinBackspaceMobile(event, 2)">
                    <input type="tel" class="pin-input-mobile" maxlength="1" pattern="[0-9]" 
                           oninput="moveToNextMobile(this, 4)" onkeydown="handlePinBackspaceMobile(event, 3)">
                    <input type="tel" class="pin-input-mobile" maxlength="1" pattern="[0-9]" 
                           onkeydown="handlePinBackspaceMobile(event, 4)">
                </div>
                
                <div id="redeemErrorMessageMobile" class="alert alert-danger mt-3 d-none"></div>
                
                <button type="button" class="redeem-btn w-100 mt-4" id="verifyPinBtnMobile" onclick="verifyPinMobile()">
                    <i class="fas fa-key"></i>
                    <span class="text-english">Verify PIN</span>
                    <span class="text-arabic">تحقق من PIN</span>
                    <span class="text-french">Vérifier le PIN</span>
                </button>
            </div>
            
            <!-- Step 2: Display Code -->
            <div id="redeemStep2Mobile" style="display: none;">
                <div class="text-center">
                    <p class="text-success mb-3 text-english">✅ PIN verified successfully!</p>
                    <p class="text-success mb-3 text-arabic">✅ تم التحقق من PIN بنجاح!</p>
                    <p class="text-success mb-3 text-french">✅ PIN vérifié avec succès !</p>
                    
                    <p class="mt-4 text-english">Show this code to cashier:</p>
                    <p class="mt-4 text-arabic">اعرض هذا الرمز للكاشير:</p>
                    <p class="mt-4 text-french">Montrez ce code au caissier :</p>
                    
                    <div class="verification-code bg-light p-3 rounded my-3" id="generatedCodeMobile" style="font-size: 1.5rem; font-weight: bold; letter-spacing: 2px;"></div>
                    
                    <div class="timer-display text-danger mb-3" id="codeTimerMobile">
                        <i class="fas fa-clock"></i>
                        <span id="timerValueMobile">05:00</span>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <small class="text-english">Code sent to store owner automatically</small>
                        <small class="text-arabic">تم إرسال الرمز إلى صاحب المتجر تلقائياً</small>
                        <small class="text-french">Code envoyé au propriétaire du magasin automatiquement</small>
                    </div>
                    
                    <button type="button" class="redeem-btn w-100 mt-3" onclick="completeRedemptionMobile()">
                        <i class="fas fa-check-circle"></i>
                        <span class="text-english">I've Shown the Code</span>
                        <span class="text-arabic">لقد عرضت الرمز</span>
                        <span class="text-french">J'ai montré le code</span>
                    </button>
                </div>
            </div>
            
            <!-- Step 3: Success -->
            <div id="redeemSuccessMobile" style="display: none;">
                <div class="text-center py-4">
                    <div class="mb-4">
                        <i class="fas fa-check-circle fa-4x text-success"></i>
                    </div>
                    <h5 class="text-success mb-3 text-english">Successfully Redeemed!</h5>
                    <h5 class="text-success mb-3 text-arabic">تم الاستبدال بنجاح!</h5>
                    <h5 class="text-success mb-3 text-french">Offre utilisée avec succès !</h5>
                    <p id="redeemSuccessMessageMobile" class="mb-4"></p>
                    
                    <button type="button" class="btn btn-warning mb-2" onclick="openRatingModalMobile()">
                        <i class="fas fa-star"></i>
                        <span class="text-english">Rate This Deal</span>
                        <span class="text-arabic">قيم هذا العرض</span>
                        <span class="text-french">Évaluer cette offre</span>
                    </button>
                    
                    <button type="button" class="btn btn-outline-secondary w-100" onclick="closeRedeemModalMobile()">
                        <i class="fas fa-times"></i>
                        <span class="text-english">Close</span>
                        <span class="text-arabic">إغلاق</span>
                        <span class="text-french">Fermer</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Rating Modal -->
    <div id="ratingModalMobile" class="modal-mobile">
        <div class="modal-content-mobile">
            <span class="close-modal" onclick="closeRatingModalMobile()">&times;</span>
            
            <h4 class="text-center mb-4">
                <span class="text-english">Rate This Deal</span>
                <span class="text-arabic">تقييم العرض</span>
                <span class="text-french">Évaluer cette offre</span>
            </h4>
            
            <div class="text-center mb-4">
                <h5 id="ratingDealNameMobile"></h5>
                <p class="text-muted" id="ratingStoreNameMobile"></p>
            </div>
            
            <div id="ratingFormMobile">
                <div class="text-center">
                    <p class="mb-3 text-english">How would you rate this deal?</p>
                    <p class="mb-3 text-arabic">كيف تقيم هذا العرض؟</p>
                    <p class="mb-3 text-french">Comment évaluez-vous cette offre ?</p>
                    
                    <div class="rating-stars-mobile" id="ratingStarsContainerMobile">
                        <div class="rating-star-mobile" data-rating="1">★</div>
                        <div class="rating-star-mobile" data-rating="2">★</div>
                        <div class="rating-star-mobile" data-rating="3">★</div>
                        <div class="rating-star-mobile" data-rating="4">★</div>
                        <div class="rating-star-mobile" data-rating="5">★</div>
                    </div>
                    
                    <div class="rating-text mb-4" id="ratingTextMobile">
                        <span class="text-english">Click on stars to rate</span>
                        <span class="text-arabic">انقر على النجوم للتقييم</span>
                        <span class="text-french">Cliquez sur les étoiles pour évaluer</span>
                    </div>
                    
                    <div class="mb-3">
                        <label for="customerNameMobile" class="form-label text-english">Your Name (Optional)</label>
                        <label for="customerNameMobile" class="form-label text-arabic">اسمك (اختياري)</label>
                        <label for="customerNameMobile" class="form-label text-french">Votre nom (optionnel)</label>
                        <input type="text" class="form-control" id="customerNameMobile" 
                               placeholder="Your name"
                               data-placeholder-en="Your name"
                               data-placeholder-ar="اسمك"
                               data-placeholder-fr="Votre nom">
                    </div>
                    
                    <div class="mb-4">
                        <label for="ratingCommentMobile" class="form-label text-english">Your Comment (Optional)</label>
                        <label for="ratingCommentMobile" class="form-label text-arabic">تعليقك (اختياري)</label>
                        <label for="ratingCommentMobile" class="form-label text-french">Votre commentaire (optionnel)</label>
                        <textarea class="form-control" id="ratingCommentMobile" rows="3" 
                                  placeholder="Share your experience..."
                                  data-placeholder-en="Share your experience..."
                                  data-placeholder-ar="شارك تجربتك..."
                                  data-placeholder-fr="Partagez votre expérience..."></textarea>
                    </div>
                    
                    <div id="ratingErrorMessageMobile" class="alert alert-danger d-none"></div>
                    
                    <button type="button" class="redeem-btn w-100" id="submitRatingBtnMobile" onclick="submitRatingMobile()">
                        <i class="fas fa-paper-plane"></i>
                        <span class="text-english">Submit Rating</span>
                        <span class="text-arabic">إرسال التقييم</span>
                        <span class="text-french">Soumettre l'évaluation</span>
                    </button>
                </div>
            </div>
            
            <div id="ratingSuccessMobile" style="display: none;">
                <div class="text-center py-4">
                    <div class="mb-4">
                        <i class="fas fa-check-circle fa-4x text-success"></i>
                    </div>
                    <h5 class="text-success mb-3 text-english">Thank You!</h5>
                    <h5 class="text-success mb-3 text-arabic">شكراً لك!</h5>
                    <h5 class="text-success mb-3 text-french">Merci !</h5>
                    <p id="ratingSuccessMessageMobile" class="mb-4"></p>
                    <button type="button" class="redeem-btn" onclick="closeRatingModalMobile()">
                        <i class="fas fa-check"></i>
                        <span class="text-english">OK</span>
                        <span class="text-arabic">موافق</span>
                        <span class="text-french">OK</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- UPDATED: Map Modal - Full Screen -->
    <div id="mapModalMobile" class="map-modal-mobile">
        <div class="map-content-mobile">
            <span class="close-modal" onclick="closeMapModalMobile()">&times;</span>
            
            <h4 class="text-center mb-3">
                <span class="text-english">Ottawa Deals Map</span>
                <span class="text-arabic">خريطة عروض أوتاوا</span>
                <span class="text-french">Carte des offres d'Ottawa</span>
            </h4>
            
            <div id="storeMapMobile"></div>
            
            <div class="mt-3 text-center">
                <small class="text-muted">
                    <i class="fas fa-info-circle"></i>
                    <span class="text-english">Tap on markers for deal details</span>
                    <span class="text-arabic">انقر على العلامات لتفاصيل العرض</span>
                    <span class="text-french">Appuyez sur les marqueurs pour les détails de l'offre</span>
                </small>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModalMobile" class="modal-mobile">
        <div class="modal-content-mobile">
            <span class="close-modal" onclick="closeProfileModalMobile()">&times;</span>
            
            <h4 class="text-center mb-4">
                <span class="text-english">My Profile</span>
                <span class="text-arabic">الملف الشخصي</span>
                <span class="text-french">Mon profil</span>
            </h4>
            
            <div class="text-center mb-4">
                <div class="user-avatar mx-auto mb-3" id="profileAvatarMobile" style="width: 80px; height: 80px; font-size: 2rem;"></div>
                <h5 id="profileUserNameMobile"></h5>
                <p class="text-muted" id="profileUserEmailMobile"></p>
                <p class="text-muted" id="profileUserPhoneMobile"></p>
                <span class="phone-verified" id="profilePhoneVerified" style="display:none;">
                    <i class="fas fa-check-circle"></i>
                    <span class="text-english">Verified</span>
                    <span class="text-arabic">مُتحقّق منه</span>
                    <span class="text-french">Vérifié</span>
                </span>
                <!-- Subscription Badge in Profile -->
                <div id="profileSubscriptionBadge" class="subscription-badge" style="margin-top:12px; display:none;">
                    <i class="fas fa-crown"></i>
                    <span class="text-english">Premium Member</span>
                    <span class="text-arabic">عضو مميز</span>
                    <span class="text-french">Membre Premium</span>
                </div>
            </div>
            
            <div class="list-group">
                <!-- THIS BUTTON NOW OPENS THE SAVINGS MODAL - My Redeemed Deals -->
                <button class="list-group-item list-group-item-action text-start" onclick="viewMyRedemptionsMobile()">
                    <i class="fas fa-ticket-alt"></i>
                    <span class="text-english">My Redeemed Deals</span>
                    <span class="text-arabic">عروضي المستبدلة</span>
                    <span class="text-french">Mes offres utilisées</span>
                </button>
                <button class="list-group-item list-group-item-action text-start" onclick="viewSavedDealsMobile()">
                    <i class="fas fa-bookmark"></i>
                    <span class="text-english">Saved Deals</span>
                    <span class="text-arabic">العروض المحفوظة</span>
                    <span class="text-french">Offres enregistrées</span>
                </button>
                <button class="list-group-item list-group-item-action text-start" onclick="viewMyReviewsMobile()">
                    <i class="fas fa-star"></i>
                    <span class="text-english">My Reviews</span>
                    <span class="text-arabic">تقييماتي</span>
                    <span class="text-french">Mes avis</span>
                </button>
                <!-- NEW: SUBSCRIPTION BUTTON WITH STRIPE -->
                <button class="list-group-item list-group-item-action text-start" onclick="openSubscriptionModal()">
                    <i class="fas fa-crown" style="color:var(--subscription-indigo);"></i>
                    <span class="text-english">Subscribe to AloOttawa+</span>
                    <span class="text-arabic">اشترك في AloOttawa+</span>
                    <span class="text-french">S'abonner à AloOttawa+</span>
                </button>
                <!-- NEW: PAYMENT METHODS BUTTON (Saved Cards) -->
                <button class="list-group-item list-group-item-action text-start" onclick="openPaymentMethodsModal()">
                    <i class="fas fa-credit-card" style="color:var(--stripe-purple);"></i>
                    <span class="text-english">Payment Methods</span>
                    <span class="text-arabic">طرق الدفع</span>
                    <span class="text-french">Méthodes de paiement</span>
                </button>
                <button class="list-group-item list-group-item-action text-start" onclick="viewSettingsMobile()">
                    <i class="fas fa-cog"></i>
                    <span class="text-english">Settings</span>
                    <span class="text-arabic">الإعدادات</span>
                    <span class="text-french">Paramètres</span>
                </button>
                <button class="list-group-item list-group-item-action text-danger text-start" onclick="logoutUserMobile()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="text-english">Logout</span>
                    <span class="text-arabic">تسجيل الخروج</span>
                    <span class="text-french">Déconnexion</span>
                </button>
            </div>
        </div>
    </div>

    <!-- MY SAVINGS MODAL - This is the Monthly Savings summary (accessed via Profile -> My Redeemed Deals) -->
    <div id="mySavingsModalMobile" class="modal-mobile">
        <div class="modal-content-mobile">
            <span class="close-modal" onclick="closeMySavingsModal()">&times;</span>
            
            <h4 class="text-center mb-4">
                <span class="text-english">My Monthly Savings</span>
                <span class="text-arabic">مدخراتي الشهرية</span>
                <span class="text-french">Mes économies mensuelles</span>
            </h4>
            
            <div class="savings-summary">
                <div class="savings-big-number" id="modalTotalSavingsMobile">$0.00</div>
                <div class="text-english">This Month's Savings with AloOttawa</div>
                <div class="text-arabic">مدخرات هذا الشهر مع AloOttawa</div>
                <div class="text-french">Économies de ce mois-ci avec AloOttawa</div>
            </div>
            
            <div class="savings-stats-grid">
                <div class="savings-stat-card">
                    <div class="savings-stat-icon">
                        <i class="fas fa-ticket-alt"></i>
                    </div>
                    <div class="savings-stat-value" id="totalRedeemedCount">0</div>
                    <div class="savings-stat-label text-english">Deals Redeemed</div>
                    <div class="savings-stat-label text-arabic">العروض المستبدلة</div>
                    <div class="savings-stat-label text-french">Offres utilisées</div>
                </div>
                <div class="savings-stat-card">
                    <div class="savings-stat-icon">
                        <i class="fas fa-percent"></i>
                    </div>
                    <div class="savings-stat-value" id="avgSavingsPerDeal">$0.00</div>
                    <div class="savings-stat-label text-english">Avg. Saved/Deal</div>
                    <div class="savings-stat-label text-arabic">متوسط التوفير/العرض</div>
                    <div class="savings-stat-label text-french">Moy. économisé/offre</div>
                </div>
                <div class="savings-stat-card">
                    <div class="savings-stat-icon">
                        <i class="fas fa-tag"></i>
                    </div>
                    <div class="savings-stat-value" id="avgDiscountRate">0%</div>
                    <div class="savings-stat-label text-english">Avg. Discount</div>
                    <div class="savings-stat-label text-arabic">متوسط الخصم</div>
                    <div class="savings-stat-label text-french">Remise moyenne</div>
                </div>
                <div class="savings-stat-card">
                    <div class="savings-stat-icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div class="savings-stat-value" id="firstRedemptionDate">-</div>
                    <div class="savings-stat-label text-english">First Savings</div>
                    <div class="savings-stat-label text-arabic">أول توفير</div>
                    <div class="savings-stat-label text-french">Premières économies</div>
                </div>
            </div>
            
            <div class="mt-3">
                <h5 class="text-english">Recent Savings This Month</h5>
                <h5 class="text-arabic">المدخرات الأخيرة هذا الشهر</h5>
                <h5 class="text-french">Économies récentes ce mois-ci</h5>
                <div id="recentSavingsList" class="savings-timeline">
                    <!-- Timeline items will be inserted here -->
                </div>
                <div id="noSavingsYet" class="text-center py-4 text-muted">
                    <i class="fas fa-piggy-bank fa-2x mb-2"></i>
                    <div class="text-english">No savings this month. Start redeeming deals!</div>
                    <div class="text-arabic">لا توجد مدخرات هذا الشهر. ابدأ باستبدال العروض!</div>
                    <div class="text-french">Pas d'économies ce mois-ci. Commencez à utiliser des offres !</div>
                </div>
            </div>
            
            <div class="mt-4">
                <button class="redeem-btn w-100" onclick="closeMySavingsModal()">
                    <i class="fas fa-check"></i>
                    <span class="text-english">OK</span>
                    <span class="text-arabic">موافق</span>
                    <span class="text-french">OK</span>
                </button>
            </div>
        </div>
    </div>

    <!-- ========== NEW: SUBSCRIPTION MODAL - STRIPE PAYMENT ========== -->
    <div id="subscriptionModalMobile" class="modal-mobile">
        <div class="modal-content-mobile">
            <span class="close-modal" onclick="closeSubscriptionModal()">&times;</span>
            
            <h4 class="text-center mb-4">
                <span class="text-english">AloOttawa+ Subscription</span>
                <span class="text-arabic">اشتراك AloOttawa+</span>
                <span class="text-french">Abonnement AloOttawa+</span>
            </h4>

            <div class="subscription-plan text-center">
                <span class="plan-popular">
                    <span class="text-english">MOST POPULAR</span>
                    <span class="text-arabic">الأكثر شهرة</span>
                    <span class="text-french">PLUS POPULAIRE</span>
                </span>
                <h5 class="mt-3">
                    <span class="text-english">Monthly Premium</span>
                    <span class="text-arabic">اشتراك شهري مميز</span>
                    <span class="text-french">Abonnement mensuel premium</span>
                </h5>
                <div class="pricing">
                    $9.99 <small>/mo</small>
                </div>
                <p class="mt-2 text-muted">
                    <span class="text-english">Cancel anytime</span>
                    <span class="text-arabic">إلغاء في أي وقت</span>
                    <span class="text-french">Annulez à tout moment</span>
                </p>
                <hr>
                <div class="text-start mt-3">
                    <p><i class="fas fa-check-circle text-success me-2"></i> <span class="text-english">Exclusive member‑only deals</span><span class="text-arabic">عروض حصرية للأعضاء</span><span class="text-french">Offres exclusives membres</span></p>
                    <p><i class="fas fa-check-circle text-success me-2"></i> <span class="text-english">Early access to new deals</span><span class="text-arabic">وصول مبكر للعروض الجديدة</span><span class="text-french">Accès anticipé aux nouvelles offres</span></p>
                    <p><i class="fas fa-check-circle text-success me-2"></i> <span class="text-english">No fees on redemptions</span><span class="text-arabic">بدون رسوم على الاستبدال</span><span class="text-french">Sans frais sur les utilisations</span></p>
                </div>
            </div>

            <!-- Saved Cards Section (if any) -->
            <div id="savedCardsSection" style="display: none;">
                <h6 class="mb-3">
                    <span class="text-english">Saved Payment Methods</span>
                    <span class="text-arabic">طرق الدفع المحفوظة</span>
                    <span class="text-french">Méthodes de paiement enregistrées</span>
                </h6>
                <div id="savedCardsList" class="saved-cards-list">
                    <!-- Saved cards will be inserted here dynamically -->
                </div>
                <div class="text-center mb-3">
                    <small class="text-muted">
                        <span class="text-english">— OR —</span>
                        <span class="text-arabic">— أو —</span>
                        <span class="text-french">— OU —</span>
                    </small>
                </div>
            </div>

            <!-- Payment Method Selection -->
            <div class="stripe-payment-methods">
                <button class="stripe-payment-method-btn active" id="cardPaymentBtn" onclick="selectPaymentMethod('card')">
                    <i class="fas fa-credit-card"></i>
                    <span class="text-english">Card</span>
                    <span class="text-arabic">بطاقة</span>
                    <span class="text-french">Carte</span>
                </button>
                <button class="stripe-payment-method-btn" id="googlePayBtn" onclick="selectPaymentMethod('googlepay')">
                    <i class="fab fa-google-pay"></i>
                    <span>Google Pay</span>
                </button>
                <button class="stripe-payment-method-btn" id="applePayBtn" onclick="selectPaymentMethod('applepay')">
                    <i class="fab fa-apple-pay"></i>
                    <span>Apple Pay</span>
                </button>
            </div>

            <!-- Stripe Card Element -->
            <div id="stripeCardPayment">
                <div class="mb-3">
                    <label class="form-label">
                        <span class="text-english">Card Details</span>
                        <span class="text-arabic">بيانات البطاقة</span>
                        <span class="text-french">Détails de la carte</span>
                    </label>
                    <div id="cardElement" class="stripe-card-element">
                        <!-- Stripe.js will inject the Card Element here -->
                    </div>
                    <div id="cardErrors" class="card-error-message" role="alert"></div>
                    <div id="cardSuccess" class="card-success-message" role="alert"></div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-6">
                        <label class="form-label">
                            <span class="text-english">Cardholder Name</span>
                            <span class="text-arabic">اسم حامل البطاقة</span>
                            <span class="text-french">Nom du titulaire</span>
                        </label>
                        <input type="text" class="form-control" id="cardholderNameMobile" 
                               placeholder="John Doe"
                               data-placeholder-en="John Doe"
                               data-placeholder-ar="John Doe"
                               data-placeholder-fr="John Doe">
                    </div>
                    <div class="col-6">
                        <label class="form-label">
                            <span class="text-english">Postal Code</span>
                            <span class="text-arabic">الرمز البريدي</span>
                            <span class="text-french">Code postal</span>
                        </label>
                        <input type="text" class="form-control" id="postalCodeMobile" 
                               placeholder="K1A 0B1"
                               data-placeholder-en="K1A 0B1"
                               data-placeholder-ar="K1A 0B1"
                               data-placeholder-fr="K1A 0B1">
                    </div>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="saveCardForFutureMobile">
                    <label class="form-check-label" for="saveCardForFutureMobile">
                        <span class="text-english">Save card for future payments</span>
                        <span class="text-arabic">حفظ البطاقة للمدفوعات المستقبلية</span>
                        <span class="text-french">Enregistrer la carte pour les futurs paiements</span>
                    </label>
                </div>
            </div>

            <div id="subscriptionErrorMessage" class="alert alert-danger d-none"></div>
            <div id="subscriptionSuccessMessage" class="alert alert-success d-none">
                <span class="text-english">🎉 Subscription successful! You are now a premium member.</span>
                <span class="text-arabic">🎉 تم الاشتراك بنجاح! أنت الآن عضو مميز.</span>
                <span class="text-french">🎉 Abonnement réussi ! Vous êtes maintenant membre premium.</span>
            </div>

            <button class="subscribe-btn" id="subscribeButton" onclick="processStripePayment()">
                <i class="fas fa-lock"></i>
                <span class="text-english">Subscribe Now – $9.99/month</span>
                <span class="text-arabic">اشترك الآن – 9.99$ /شهر</span>
                <span class="text-french">S'abonner – 9,99$/mois</span>
            </button>
            
            <div class="stripe-badge">
                <i class="fab fa-stripe"></i>
                <span class="text-english">Secure payments powered by Stripe</span>
                <span class="text-arabic">مدفوعات آمنة عبر Stripe</span>
                <span class="text-french">Paiements sécurisés par Stripe</span>
                <i class="fas fa-shield-alt ms-2"></i>
            </div>
            <p class="text-center text-muted mt-2 small">
                <span class="text-english">Your card will be charged immediately. Secure payment.</span>
                <span class="text-arabic">سيتم خصم المبلغ فوراً. دفع آمن.</span>
                <span class="text-french">Votre carte sera débitée immédiatement. Paiement sécurisé.</span>
            </p>
        </div>
    </div>

    <!-- ========== NEW: PAYMENT METHODS MODAL (SAVED CARDS) ========== -->
    <div id="paymentMethodsModalMobile" class="modal-mobile">
        <div class="modal-content-mobile">
            <span class="close-modal" onclick="closePaymentMethodsModal()">&times;</span>
            
            <h4 class="text-center mb-4">
                <span class="text-english">Payment Methods</span>
                <span class="text-arabic">طرق الدفع</span>
                <span class="text-french">Méthodes de paiement</span>
            </h4>

            <div id="savedCardsFullList" class="mb-4">
                <!-- Full list of saved cards will be inserted here -->
            </div>

            <div class="text-center mt-3">
                <button class="btn btn-outline-primary" onclick="openSubscriptionModal()">
                    <i class="fas fa-plus"></i>
                    <span class="text-english">Add New Card</span>
                    <span class="text-arabic">إضافة بطاقة جديدة</span>
                    <span class="text-french">Ajouter une nouvelle carte</span>
                </button>
            </div>

            <div class="mt-4">
                <button class="redeem-btn w-100" onclick="closePaymentMethodsModal()">
                    <i class="fas fa-check"></i>
                    <span class="text-english">Done</span>
                    <span class="text-arabic">تم</span>
                    <span class="text-french">Terminé</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Alert Message Container -->
    <div id="alertMobile"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Leaflet JS for maps -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // ============== PRODUCTION BACKEND CONFIG ==============
        const BACKEND_URL = 'http://localhost:3000'; // Change this to your actual backend URL when deployed
        // ============== STRIPE INTEGRATION ==============
        // Replace with your actual Stripe publishable key
        const STRIPE_PUBLISHABLE_KEY = 'pk_test_51T0PrTFNzjZ1GkeLOkVw1x1KsJLaq3dAFkvM3M0igh7Vn34UgN83Eqw0ScSpV5CtaKKXjiYpAJBQYkuREWeon6zt00m2BAwGmN';
        const STRIPE_PRICE_ID = 'price_1T0RkHFNzjZ1GkeLAoyfEbQy'; // حط الـ ID بتاع السعر هنا
        const STRIPE_CURRENCY = 'cad'; // لو عايز الدولار الكندي، غيرها لـ 'cad'
        let stripe = null;
        let elements = null;
        let cardElement = null;
        let selectedPaymentMethod = 'card';
        let paymentIntentClientSecret = null;
        let savedCustomerPaymentMethods = [];
        
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBdujq0sn6pQGZktiAyaeTntGlfQ8MYVP4",
            authDomain: "ottawa-deals.firebaseapp.com",
            projectId: "ottawa-deals",
            storageBucket: "ottawa-deals.firebasestorage.app",
            messagingSenderId: "468903353105",
            appId: "1:468903353105:web:864ea92efea5c5c6bc0ab0",
            measurementId: "G-L06FJJ1D5E"
        };

        // Initialize Firebase
        let app;
        let auth;
        let db;
        let recaptchaVerifier;
        let confirmationResult;
        
        try {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization error:', error);
        }

        // Initialize Stripe
        function initStripe() {
            if (stripe) return;
            
            try {
                stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
                elements = stripe.elements();
                
                // Create card Element and customize styling
                const style = {
                    base: {
                        color: '#32325d',
                        fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
                        fontSmoothing: 'antialiased',
                        fontSize: '16px',
                        '::placeholder': {
                            color: '#aab7c4'
                        },
                        padding: '10px 12px',
                    },
                    invalid: {
                        color: '#fa755a',
                        iconColor: '#fa755a'
                    }
                };
                
                cardElement = elements.create('card', { 
                    style: style,
                    hidePostalCode: true // We'll collect postal code separately
                });
                
                console.log('Stripe initialized successfully');
            } catch (error) {
                console.error('Stripe initialization error:', error);
            }
        }

        // Mobile App State Variables
        let allDeals = [];
        let filteredDeals = [];
        let currentCategory = 'all';
        let currentRedeemDeal = null;
        let generatedCode = null;
        let codeExpiryTimer = null;
        let currentRating = 0;
        let userLocation = null;
        let map = null;
        let mapMarkers = [];
        let currentDistance = 5;
        let locationFilterActive = false;
        let currentUser = null;
        let currentLanguage = 'en';
        let pendingRegistration = null;
        let otpTimer = null;
        let otpExpiryTime = null;
        let demoMode = false;
        let dealsToShowLimit = 6;

        // Savings Tracking Variables - CHANGED to monthly only
        let userRedemptions = [];
        let totalSavingsThisMonth = 0; // Only for current month

        // NEW: Subscription state with Stripe
        let isSubscribed = false;
        let stripeCustomerId = null;

        // Language texts for dynamic content
        const languageTexts = {
            en: {
                greetings: {
                    morning: "Good morning",
                    afternoon: "Good afternoon",
                    evening: "Good evening"
                },
                ratingTexts: {
                    1: "Very Poor",
                    2: "Poor",
                    3: "Average",
                    4: "Good",
                    5: "Excellent"
                },
                alerts: {
                    loginSuccess: "Welcome {name}! Login successful",
                    signupSuccess: "Congratulations {name}! Account created",
                    logoutSuccess: "Logged out successfully",
                    locationFound: "Location found! Showing nearby deals",
                    dealRefreshed: "Deals refreshed successfully",
                    dealRedeemed: "Deal redeemed successfully! You saved ${savings}",
                    ratingSubmitted: "Thank you for your rating!",
                    codeGenerated: "Code generated! Show to cashier",
                    pinVerified: "PIN verified successfully",
                    otpSent: "Verification code sent to {phone}",
                    otpVerified: "Phone number verified successfully",
                    phoneExists: "Phone number already registered. Please login instead",
                    resendOTP: "New verification code sent",
                    dealsSynced: "Deals synced with store dashboard",
                    resetPasswordSent: "Password reset email sent",
                    phoneLoginSuccess: "Phone login successful",
                    firebaseError: "Authentication error: {error}",
                    subscriptionSuccess: "Thank you! You are now a Premium member.",
                    subscriptionError: "Payment failed: {error}",
                    cardSaved: "Card saved successfully for future payments",
                    cardRemoved: "Card removed successfully"
                }
            },
            ar: {
                greetings: {
                    morning: "صباح الخير",
                    afternoon: "مساء الخير",
                    evening: "مساء الخير"
                },
                ratingTexts: {
                    1: "سيء جداً",
                    2: "سيء",
                    3: "متوسط",
                    4: "جيد",
                    5: "ممتاز"
                },
                alerts: {
                    loginSuccess: "مرحباً {name}! تم تسجيل الدخول بنجاح",
                    signupSuccess: "مبروك {name}! تم إنشاء الحساب",
                    logoutSuccess: "تم تسجيل الخروج بنجاح",
                    locationFound: "تم تحديد الموقع! يتم عرض العروض القريبة",
                    dealRefreshed: "تم تحديث العروض بنجاح",
                    dealRedeemed: "تم استبدال العرض بنجاح! وفرت ${savings}",
                    ratingSubmitted: "شكراً لتقييمك!",
                    codeGenerated: "تم إنشاء الرمز! اعرضه للكاشير",
                    pinVerified: "تم التحقق من PIN بنجاح",
                    otpSent: "تم إرسال رمز التحقق إلى {phone}",
                    otpVerified: "تم التحقق من رقم الجوال بنجاح",
                    phoneExists: "رقم الجوال مسجل بالفعل. الرجاء تسجيل الدخول",
                    resendOTP: "تم إرسال رمز تحقق جديد",
                    dealsSynced: "تم مزامنة العروض مع لوحة تحكم المتاجر",
                    resetPasswordSent: "تم إرسال بريد إعادة تعيين كلمة المرور",
                    phoneLoginSuccess: "تم تسجيل الدخول بالهاتف بنجاح",
                    firebaseError: "خطأ في المصادقة: {error}",
                    subscriptionSuccess: "شكراً! أنت الآن عضو مميز.",
                    subscriptionError: "فشل الدفع: {error}",
                    cardSaved: "تم حفظ البطاقة بنجاح للمدفوعات المستقبلية",
                    cardRemoved: "تم إزالة البطاقة بنجاح"
                }
            },
            fr: {
                greetings: {
                    morning: "Bonjour",
                    afternoon: "Bon après-midi",
                    evening: "Bonsoir"
                },
                ratingTexts: {
                    1: "Très mauvais",
                    2: "Mauvais",
                    3: "Moyen",
                    4: "Bon",
                    5: "Excellent"
                },
                alerts: {
                    loginSuccess: "Bienvenue {name} ! Connexion réussie",
                    signupSuccess: "Félicitations {name} ! Compte créé",
                    logoutSuccess: "Déconnexion réussie",
                    locationFound: "Localisation trouvée ! Affichage des offres à proximité",
                    dealRefreshed: "Offres actualisées avec succès",
                    dealRedeemed: "Offre utilisée avec succès ! Vous avez économisé ${savings}",
                    ratingSubmitted: "Merci pour votre évaluation !",
                    codeGenerated: "Code généré ! Montrez-le au caissier",
                    pinVerified: "PIN vérifié avec succès",
                    otpSent: "Code de vérification envoyé à {phone}",
                    otpVerified: "Numéro de mobile vérifié avec succès",
                    phoneExists: "Numéro de mobile déjà enregistré. Veuillez vous connecter",
                    resendOTP: "Nouveau code de vérification envoyé",
                    dealsSynced: "Offres synchronisées avec le tableau de bord des magasins",
                    resetPasswordSent: "Email de réinitialisation du mot de passe envoyé",
                    phoneLoginSuccess: "Connexion téléphonique réussie",
                    firebaseError: "Erreur d'authentification : {error}",
                    subscriptionSuccess: "Merci ! Vous êtes maintenant membre premium.",
                    subscriptionError: "Paiement échoué : {error}",
                    cardSaved: "Carte enregistrée avec succès pour les futurs paiements",
                    cardRemoved: "Carte retirée avec succès"
                }
            }
        };

        // Initialize Mobile App
        function initMobileApp() {
            console.log('Initializing mobile app...');
            
            // Initialize Stripe
            initStripe();
            
            // Initialize Firebase Auth State Observer
            initFirebaseAuth();
            
            // Load preferences first
            loadPreferences();
            
            // Update time display
            updateTime();
            setInterval(updateTime, 60000);
            
            // Setup storage sync for real-time updates
            setupStorageSync();
            
            // Load user savings data (monthly only)
            loadUserSavingsData();
            
            // Load initial deals (including demo deals for new categories)
            loadDealsMobile();
            
            // Setup event listeners
            setupMobileEventListeners();
            
            // Setup rating stars
            setupRatingStarsMobile();
            
            // Setup phone input
            setupPhoneInput();

            // Load subscription status
            loadSubscriptionStatus();
            
            console.log('Mobile app initialized');
        }

        // ============== STRIPE PAYMENT FUNCTIONS ==============
        
        // Select payment method (card, googlepay, applepay)
        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            
            // Update UI
            document.querySelectorAll('.stripe-payment-method-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (method === 'card') {
                document.getElementById('cardPaymentBtn').classList.add('active');
                document.getElementById('stripeCardPayment').style.display = 'block';
            } else if (method === 'googlepay') {
                document.getElementById('googlePayBtn').classList.add('active');
                document.getElementById('stripeCardPayment').style.display = 'none';
                showAlertMobile(
                    currentLanguage === 'ar' ? 'Google Pay متوفر في الإصدار التجريبي' : 
                    currentLanguage === 'fr' ? 'Google Pay disponible en version démo' :
                    'Google Pay available in demo mode',
                    'info'
                );
            } else if (method === 'applepay') {
                document.getElementById('applePayBtn').classList.add('active');
                document.getElementById('stripeCardPayment').style.display = 'none';
                showAlertMobile(
                    currentLanguage === 'ar' ? 'Apple Pay متوفر في الإصدار التجريبي' : 
                    currentLanguage === 'fr' ? 'Apple Pay disponible en version démo' :
                    'Apple Pay available in demo mode',
                    'info'
                );
            }
        }

        // Mount Stripe Card Element
        function mountCardElement() {
            setTimeout(() => {
                const cardElementDiv = document.getElementById('cardElement');
                if (cardElement && cardElementDiv) {
                    cardElement.mount('#cardElement');
                    console.log('Stripe card element mounted');
                    
                    // Add event listener for card validation
                    cardElement.addEventListener('change', function(event) {
                        const errorDiv = document.getElementById('cardErrors');
                        if (event.error) {
                            errorDiv.textContent = event.error.message;
                            errorDiv.style.display = 'block';
                            document.getElementById('cardSuccess').style.display = 'none';
                        } else {
                            errorDiv.style.display = 'none';
                        }
                    });
                }
            }, 300);
        }

        // ========== NEW PRODUCTION-READY PROCESS STRIPE PAYMENT ==========
        // Process Stripe Payment - PRODUCTION VERSION
        async function processStripePayment() {
            if (!currentUser) {
                showAlertMobile(
                    currentLanguage === 'ar' ? 'الرجاء تسجيل الدخول أولاً' : 
                    currentLanguage === 'fr' ? 'Veuillez vous connecter d\'abord' :
                    'Please login first',
                    'warning'
                );
                closeSubscriptionModal();
                openLoginModal();
                return;
            }

            const subscribeBtn = document.getElementById('subscribeButton');
            const originalHTML = subscribeBtn.innerHTML;
            subscribeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            subscribeBtn.disabled = true;

            try {
                if (selectedPaymentMethod === 'card') {
                    // Validate cardholder name
                    const cardholderName = document.getElementById('cardholderNameMobile').value.trim();
                    if (!cardholderName) {
                        throw new Error(
                            currentLanguage === 'ar' ? 'الرجاء إدخال اسم حامل البطاقة' :
                            currentLanguage === 'fr' ? 'Veuillez saisir le nom du titulaire' :
                            'Please enter cardholder name'
                        );
                    }

                    // Create payment method with Stripe
                    const { paymentMethod, error } = await stripe.createPaymentMethod({
                        type: 'card',
                        card: cardElement,
                        billing_details: {
                            name: cardholderName,
                            email: currentUser.email,
                        },
                    });

                    if (error) {
                        throw error;
                    }

                    console.log('Payment method created:', paymentMethod.id);

                    // Show processing message
                    showAlertMobile(
                        currentLanguage === 'ar' ? 'جاري معالجة الدفع...' :
                        currentLanguage === 'fr' ? 'Traitement du paiement...' :
                        'Processing payment...',
                        'info'
                    );

                    // Call our backend to create subscription
                    const response = await fetch(`${BACKEND_URL}/api/create-subscription`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            paymentMethodId: paymentMethod.id,
                            priceId: STRIPE_PRICE_ID,
                            userId: currentUser.id,
                            userEmail: currentUser.email,
                            userName: currentUser.name,
                            saveCard: document.getElementById('saveCardForFutureMobile').checked
                        })
                    });

                    const result = await response.json();

                    if (!result.success) {
                        throw new Error(result.error);
                    }

                    // Handle 3D Secure if needed (for cards that require authentication)
                    if (result.clientSecret) {
                        const { error: confirmError } = await stripe.confirmCardPayment(
                            result.clientSecret
                        );

                        if (confirmError) {
                            throw confirmError;
                        }
                    }

                    // Success!
                    handleSuccessfulSubscription(result);
                    
                } else if (selectedPaymentMethod === 'googlepay') {
                    showAlertMobile(
                        currentLanguage === 'ar' ? 'Google Pay قيد التطوير' :
                        currentLanguage === 'fr' ? 'Google Pay en développement' :
                        'Google Pay coming soon',
                        'info'
                    );
                    subscribeBtn.innerHTML = originalHTML;
                    subscribeBtn.disabled = false;
                } else if (selectedPaymentMethod === 'applepay') {
                    showAlertMobile(
                        currentLanguage === 'ar' ? 'Apple Pay قيد التطوير' :
                        currentLanguage === 'fr' ? 'Apple Pay en développement' :
                        'Apple Pay coming soon',
                        'info'
                    );
                    subscribeBtn.innerHTML = originalHTML;
                    subscribeBtn.disabled = false;
                }
                
            } catch (error) {
                console.error('Payment error:', error);
                
                // Show user-friendly error message
                let errorMessage = error.message;
                if (errorMessage.includes('insufficient funds')) {
                    errorMessage = currentLanguage === 'ar' ? 'رصيد غير كافٍ في البطاقة' :
                                  currentLanguage === 'fr' ? 'Solde insuffisant sur la carte' :
                                  'Insufficient funds on card';
                } else if (errorMessage.includes('expired')) {
                    errorMessage = currentLanguage === 'ar' ? 'البطاقة منتهية الصلاحية' :
                                  currentLanguage === 'fr' ? 'Carte expirée' :
                                  'Card expired';
                }
                
                showSubscriptionError(errorMessage);
                subscribeBtn.innerHTML = originalHTML;
                subscribeBtn.disabled = false;
            }
        }

        // Handle successful subscription - PRODUCTION VERSION
        function handleSuccessfulSubscription(result) {
            isSubscribed = true;
            stripeCustomerId = result.customerId;
            
            // Update local storage
            localStorage.setItem('aloottawa_subscription_' + currentUser.id, 'active');
            localStorage.setItem('aloottawa_stripe_customer_' + currentUser.id, result.customerId);
            
            // Update UI
            updateSubscriptionUI();
            
            // Show success message
            document.getElementById('subscriptionSuccessMessage').classList.remove('d-none');
            document.getElementById('subscriptionErrorMessage').classList.add('d-none');
            
            // Show success alert
            showAlertMobile(
                currentLanguage === 'ar' ? '🎉 تم الاشتراك بنجاح! أنت الآن عضو مميز.' :
                currentLanguage === 'fr' ? '🎉 Abonnement réussi ! Vous êtes maintenant membre premium.' :
                '🎉 Subscription successful! You are now a premium member.',
                'success'
            );
            
            // Close modal after 2 seconds
            setTimeout(() => {
                closeSubscriptionModal();
            }, 2000);
        }

        // Load user's saved payment methods from backend
        async function loadUserPaymentMethods() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/payment-methods/${currentUser.id}`);
                const result = await response.json();
                
                if (result.success && result.paymentMethods.length > 0) {
                    savedCustomerPaymentMethods = result.paymentMethods;
                    
                    // You can display these in the payment methods modal
                    console.log('Loaded payment methods:', result.paymentMethods);
                }
            } catch (error) {
                console.error('Error loading payment methods:', error);
            }
        }

        function openSubscriptionModal() {
            if (!currentUser) {
                showAlertMobile(
                    currentLanguage === 'ar' ? 'الرجاء تسجيل الدخول أولاً' : 
                    currentLanguage === 'fr' ? 'Veuillez vous connecter d\'abord' :
                    'Please login first',
                    'warning'
                );
                openLoginModal();
                return;
            }
            
            // Reset modal
            document.getElementById('subscriptionErrorMessage').classList.add('d-none');
            document.getElementById('subscriptionSuccessMessage').classList.add('d-none');
            document.getElementById('cardholderNameMobile').value = currentUser?.name || '';
            document.getElementById('postalCodeMobile').value = '';
            document.getElementById('saveCardForFutureMobile').checked = false;
            
            // Reset payment method selection
            selectPaymentMethod('card');
            
            // Mount card element
            setTimeout(() => {
                mountCardElement();
            }, 100);
            
            // Load saved cards from backend
            loadUserPaymentMethods();
            
            // Show modal
            document.getElementById('subscriptionModalMobile').style.display = 'block';
        }

        function closeSubscriptionModal() {
            document.getElementById('subscriptionModalMobile').style.display = 'none';
            
            // Unmount card element to prevent memory leaks
            if (cardElement) {
                cardElement.unmount();
            }
        }

        function showSubscriptionError(msg) {
            const errDiv = document.getElementById('subscriptionErrorMessage');
            errDiv.textContent = msg;
            errDiv.classList.remove('d-none');
            document.getElementById('subscriptionSuccessMessage').classList.add('d-none');
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                errDiv.classList.add('d-none');
            }, 5000);
        }

        // Save card to customer's saved payment methods
        function saveCardToCustomer(cardholderName, postalCode) {
            if (!currentUser) return;
            
            const savedCards = getSavedCards();
            
            // In a real implementation, you would save the payment method ID from Stripe
            // For demo, we'll save a simulated card
            const newCard = {
                id: 'pm_' + Date.now(),
                brand: 'visa',
                last4: '4242',
                expMonth: 12,
                expYear: 2025,
                cardholderName: cardholderName,
                postalCode: postalCode,
                isDefault: savedCards.length === 0
            };
            
            savedCards.push(newCard);
            localStorage.setItem('aloottawa_saved_cards_' + currentUser.id, JSON.stringify(savedCards));
            
            showAlertMobile(languageTexts[currentLanguage].alerts.cardSaved, 'success');
        }

        // Get saved cards for current user
        function getSavedCards() {
            if (!currentUser) return [];
            
            const savedCards = localStorage.getItem('aloottawa_saved_cards_' + currentUser.id);
            return savedCards ? JSON.parse(savedCards) : [];
        }

        // Load saved cards for subscription modal
        function loadSavedCardsForSubscription() {
            const savedCards = getSavedCards();
            savedCustomerPaymentMethods = savedCards;
            
            const savedCardsSection = document.getElementById('savedCardsSection');
            const savedCardsList = document.getElementById('savedCardsList');
            
            if (savedCards.length > 0) {
                savedCardsSection.style.display = 'block';
                
                let html = '';
                savedCards.forEach((card, index) => {
                    const brandIcon = getCardBrandIcon(card.brand);
                    const expiryText = `${card.expMonth.toString().padStart(2, '0')}/${card.expYear.toString().slice(-2)}`;
                    
                    html += `
                        <div class="saved-card-item ${index === 0 ? 'selected' : ''}" onclick="selectSavedCard('${card.id}')">
                            <div class="saved-card-radio">
                                <input type="radio" name="savedCard" value="${card.id}" ${index === 0 ? 'checked' : ''}>
                            </div>
                            <div class="saved-card-details">
                                <div class="saved-card-brand">
                                    <i class="${brandIcon}"></i>
                                </div>
                                <div>
                                    <div class="saved-card-number">•••• •••• •••• ${card.last4}</div>
                                    <div class="saved-card-expiry">${expiryText}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                savedCardsList.innerHTML = html;
            } else {
                savedCardsSection.style.display = 'none';
            }
        }

        // Select a saved card for payment
        function selectSavedCard(cardId) {
            // In a real implementation, you would use the saved payment method
            showAlertMobile(
                currentLanguage === 'ar' ? 'تم تحديد البطاقة المحفوظة' :
                currentLanguage === 'fr' ? 'Carte enregistrée sélectionnée' :
                'Saved card selected',
                'info'
            );
        }

        // Get card brand icon
        function getCardBrandIcon(brand) {
            const brands = {
                visa: 'fab fa-cc-visa',
                mastercard: 'fab fa-cc-mastercard',
                amex: 'fab fa-cc-amex',
                discover: 'fab fa-cc-discover',
                jcb: 'fab fa-cc-jcb',
                diners: 'fab fa-cc-diners-club'
            };
            
            return brands[brand] || 'fas fa-credit-card';
        }

        // Remove saved card
        function removeSavedCard(cardId) {
            if (!currentUser) return;
            
            const savedCards = getSavedCards();
            const updatedCards = savedCards.filter(card => card.id !== cardId);
            localStorage.setItem('aloottawa_saved_cards_' + currentUser.id, JSON.stringify(updatedCards));
            
            showAlertMobile(languageTexts[currentLanguage].alerts.cardRemoved, 'success');
            
            // Refresh the payment methods modal if open
            if (document.getElementById('paymentMethodsModalMobile').style.display === 'block') {
                loadAllSavedCards();
            }
        }

        // Load all saved cards for payment methods modal
        function loadAllSavedCards() {
            const savedCards = getSavedCards();
            const savedCardsFullList = document.getElementById('savedCardsFullList');
            
            if (savedCards.length === 0) {
                savedCardsFullList.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-credit-card fa-3x text-muted mb-3"></i>
                        <h5 class="text-english">No saved cards</h5>
                        <h5 class="text-arabic">لا توجد بطاقات محفوظة</h5>
                        <h5 class="text-french">Aucune carte enregistrée</h5>
                        <p class="text-muted text-english">Add a card to save it for future payments</p>
                        <p class="text-muted text-arabic">أضف بطاقة لحفظها للمدفوعات المستقبلية</p>
                        <p class="text-muted text-french">Ajoutez une carte pour l'enregistrer pour les futurs paiements</p>
                    </div>
                `;
                return;
            }
            
            let html = '<h6 class="mb-3 text-english">Your Saved Cards</h6><h6 class="mb-3 text-arabic">بطاقاتك المحفوظة</h6><h6 class="mb-3 text-french">Vos cartes enregistrées</h6>';
            
            savedCards.forEach((card, index) => {
                const brandIcon = getCardBrandIcon(card.brand);
                const expiryText = `${card.expMonth.toString().padStart(2, '0')}/${card.expYear.toString().slice(-2)}`;
                
                html += `
                    <div class="saved-card-item">
                        <div class="saved-card-details">
                            <div class="saved-card-brand">
                                <i class="${brandIcon}"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="saved-card-number">•••• •••• •••• ${card.last4}</div>
                                <div class="saved-card-expiry">Expires ${expiryText}</div>
                                ${card.cardholderName ? `<div class="small text-muted">${card.cardholderName}</div>` : ''}
                            </div>
                        </div>
                        <button class="btn btn-sm btn-outline-danger ms-2" onclick="removeSavedCard('${card.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            });
            
            savedCardsFullList.innerHTML = html;
        }

        // ============== SUBSCRIPTION MODAL FUNCTIONS ==============
        
        function loadSubscriptionStatus() {
            if (currentUser) {
                const sub = localStorage.getItem('aloottawa_subscription_' + currentUser.id);
                isSubscribed = sub === 'active';
                stripeCustomerId = localStorage.getItem('aloottawa_stripe_customer_' + currentUser.id);
            } else {
                isSubscribed = false;
                stripeCustomerId = null;
            }
            updateSubscriptionUI();
        }

        function updateSubscriptionUI() {
            const badge = document.getElementById('profileSubscriptionBadge');
            if (badge) {
                if (isSubscribed) {
                    badge.style.display = 'inline-flex';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        // ============== PAYMENT METHODS MODAL ==============
        
        function openPaymentMethodsModal() {
            if (!currentUser) {
                showAlertMobile(
                    currentLanguage === 'ar' ? 'الرجاء تسجيل الدخول أولاً' : 
                    currentLanguage === 'fr' ? 'Veuillez vous connecter d\'abord' :
                    'Please login first',
                    'warning'
                );
                openLoginModal();
                return;
            }
            
            loadAllSavedCards();
            document.getElementById('paymentMethodsModalMobile').style.display = 'block';
        }

        function closePaymentMethodsModal() {
            document.getElementById('paymentMethodsModalMobile').style.display = 'none';
        }

        // ============== MY SAVINGS FUNCTIONS - MONTHLY ONLY ==============
        
        // Check if a date is within the current month
        function isThisMonth(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
        }
        
        // Load user savings data from localStorage or Firestore - MONTHLY only
        function loadUserSavingsData() {
            try {
                const savedRedemptions = localStorage.getItem('aloottawa_user_redemptions');
                if (savedRedemptions) {
                    userRedemptions = JSON.parse(savedRedemptions);
                    console.log('Loaded user redemptions:', userRedemptions.length);
                } else {
                    createDemoSavingsData();
                }
                
                calculateTotalSavingsThisMonth();
                updateSavingsCard();
                
            } catch (e) {
                console.error('Error loading savings data:', e);
                userRedemptions = [];
                createDemoSavingsData();
            }
        }
        
        function createDemoSavingsData() {
            if (!currentUser) {
                const hasDemo = localStorage.getItem('aloottawa_demo_savings_created');
                if (!hasDemo) {
                    const today = new Date();
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    const lastWeek = new Date(today);
                    lastWeek.setDate(lastWeek.getDate() - 7);
                    
                    if (lastWeek.getMonth() !== today.getMonth()) {
                        lastWeek.setMonth(today.getMonth());
                        lastWeek.setFullYear(today.getFullYear());
                    }
                    if (yesterday.getMonth() !== today.getMonth()) {
                        yesterday.setMonth(today.getMonth());
                        yesterday.setFullYear(today.getFullYear());
                    }
                    
                    userRedemptions = [
                        {
                            id: 'demo1',
                            dealId: 1,
                            dealName: 'Welcome Deal!',
                            storeName: 'Demo Restaurant',
                            amountSaved: 10.00,
                            originalPrice: 20.00,
                            paidPrice: 10.00,
                            discount: 50,
                            date: lastWeek.toISOString(),
                            isDemo: true
                        },
                        {
                            id: 'demo2',
                            dealId: 2,
                            dealName: 'Weekend Special',
                            storeName: 'Demo Supermarket',
                            amountSaved: 30.00,
                            originalPrice: 100.00,
                            paidPrice: 70.00,
                            discount: 30,
                            date: yesterday.toISOString(),
                            isDemo: true
                        },
                        {
                            id: 'demo3',
                            dealId: 4,
                            dealName: 'Spa & Relaxation Package',
                            storeName: 'Serenity Spa',
                            amountSaved: 51.00,
                            originalPrice: 150.00,
                            paidPrice: 99.00,
                            discount: 34,
                            date: today.toISOString(),
                            isDemo: true
                        }
                    ];
                    
                    localStorage.setItem('aloottawa_user_redemptions', JSON.stringify(userRedemptions));
                    localStorage.setItem('aloottawa_demo_savings_created', 'true');
                    console.log('Demo savings data created (monthly)');
                }
            }
        }
        
        function calculateTotalSavingsThisMonth() {
            totalSavingsThisMonth = 0;
            userRedemptions.forEach(redemption => {
                if (isThisMonth(redemption.date)) {
                    totalSavingsThisMonth += redemption.amountSaved || 0;
                }
            });
            return totalSavingsThisMonth;
        }
        
        function updateSavingsCard() {
            const savingsAmountEl = document.getElementById('totalSavingsAmountMobile');
            if (savingsAmountEl) {
                savingsAmountEl.textContent = `$${totalSavingsThisMonth.toFixed(2)}`;
            }
        }
        
        function addRedemptionToSavings(deal, amountSaved) {
            if (!deal) return;
            
            const redemption = {
                id: 'redemption_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                dealId: deal.id,
                dealName: currentLanguage === 'ar' ? (deal.nameAr || deal.nameEn) : 
                         currentLanguage === 'fr' ? (deal.nameFr || deal.nameEn) :
                         deal.nameEn,
                storeName: currentLanguage === 'ar' ? (deal.storeNameAr || deal.storeName) : 
                          currentLanguage === 'fr' ? (deal.storeNameFr || deal.storeName) :
                          deal.storeName,
                amountSaved: amountSaved,
                originalPrice: deal.oldPrice,
                paidPrice: deal.price,
                discount: deal.discount,
                date: new Date().toISOString(),
                userId: currentUser ? currentUser.id : 'guest',
                isDemo: false
            };
            
            userRedemptions.push(redemption);
            userRedemptions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (userRedemptions.length > 50) {
                userRedemptions = userRedemptions.slice(0, 50);
            }
            
            localStorage.setItem('aloottawa_user_redemptions', JSON.stringify(userRedemptions));
            
            calculateTotalSavingsThisMonth();
            updateSavingsCard();
            
            if (db && currentUser) {
                db.collection('redemptions').add({
                    ...redemption,
                    userId: currentUser.id,
                    userEmail: currentUser.email,
                    syncedAt: firebase.firestore.FieldValue.serverTimestamp()
                }).catch(error => {
                    console.error('Error saving redemption to Firestore:', error);
                });
            }
        }
        
        function openMySavingsModal() {
            updateSavingsModal();
            document.getElementById('mySavingsModalMobile').style.display = 'block';
        }
        
        function closeMySavingsModal() {
            document.getElementById('mySavingsModalMobile').style.display = 'none';
        }
        
        function updateSavingsModal() {
            const thisMonthRedemptions = userRedemptions.filter(r => isThisMonth(r.date));
            const thisMonthTotal = thisMonthRedemptions.reduce((sum, r) => sum + (r.amountSaved || 0), 0);
            
            document.getElementById('modalTotalSavingsMobile').textContent = `$${thisMonthTotal.toFixed(2)}`;
            document.getElementById('totalRedeemedCount').textContent = thisMonthRedemptions.length;
            
            let avgSavings = 0;
            if (thisMonthRedemptions.length > 0) {
                avgSavings = thisMonthTotal / thisMonthRedemptions.length;
            }
            document.getElementById('avgSavingsPerDeal').textContent = `$${avgSavings.toFixed(2)}`;
            
            let totalDiscount = 0;
            thisMonthRedemptions.forEach(r => totalDiscount += r.discount || 0);
            let avgDiscount = thisMonthRedemptions.length > 0 ? (totalDiscount / thisMonthRedemptions.length) : 0;
            document.getElementById('avgDiscountRate').textContent = `${Math.round(avgDiscount)}%`;
            
            let firstDate = '-';
            if (thisMonthRedemptions.length > 0) {
                const oldest = [...thisMonthRedemptions].sort((a, b) => new Date(a.date) - new Date(b.date))[0];
                const date = new Date(oldest.date);
                firstDate = `${date.getMonth() + 1}/${date.getDate()}/${date.getFullYear()}`;
            }
            document.getElementById('firstRedemptionDate').textContent = firstDate;
            
            const recentList = document.getElementById('recentSavingsList');
            const noSavingsEl = document.getElementById('noSavingsYet');
            
            if (thisMonthRedemptions.length === 0) {
                recentList.innerHTML = '';
                noSavingsEl.style.display = 'block';
            } else {
                noSavingsEl.style.display = 'none';
                
                const recent = thisMonthRedemptions.slice(0, 5);
                let html = '';
                
                recent.forEach(r => {
                    const date = new Date(r.date);
                    const formattedDate = `${date.getMonth() + 1}/${date.getDate()}/${date.getFullYear()}`;
                    
                    html += `
                        <div class="timeline-item">
                            <div>
                                <div class="timeline-date">${formattedDate}</div>
                                <div class="timeline-deal">${r.dealName}</div>
                                <small class="text-muted">${r.storeName}</small>
                            </div>
                            <div class="timeline-saved">+$${r.amountSaved.toFixed(2)}</div>
                        </div>
                    `;
                });
                
                recentList.innerHTML = html;
            }
        }

        // ============== FIREBASE AUTH FUNCTIONS ==============
        
        function initFirebaseAuth() {
            if (!auth) {
                console.error('Firebase auth not available');
                return;
            }
            
            auth.onAuthStateChanged((user) => {
                if (user) {
                    console.log('User signed in:', user.email || user.phoneNumber);
                    handleUserSignedIn(user);
                } else {
                    console.log('User signed out');
                    handleUserSignedOut();
                }
            });
        }
        
        function handleUserSignedIn(user) {
            db.collection('users').doc(user.uid).get()
                .then((doc) => {
                    if (doc.exists) {
                        const userData = doc.data();
                        currentUser = {
                            id: user.uid,
                            name: userData.name || user.displayName || user.email.split('@')[0],
                            email: user.email,
                            phone: userData.phone || '',
                            photoURL: user.photoURL,
                            type: userData.type || 'user',
                            phoneVerified: userData.phoneVerified || false,
                            emailVerified: user.emailVerified || false
                        };
                        if (userData.subscription === 'active') isSubscribed = true;
                        if (userData.stripeCustomerId) stripeCustomerId = userData.stripeCustomerId;
                    } else {
                        currentUser = {
                            id: user.uid,
                            name: user.displayName || user.email.split('@')[0],
                            email: user.email,
                            phone: '',
                            photoURL: user.photoURL,
                            type: 'user',
                            phoneVerified: false,
                            emailVerified: user.emailVerified
                        };
                        
                        saveUserToFirestore(currentUser);
                    }
                    
                    localStorage.setItem('aloottawa_current_user', JSON.stringify(currentUser));
                    updateUserUIMobile();
                    loadUserSpecificSavingsData();
                    loadSubscriptionStatus();
                    
                    console.log('User authenticated:', currentUser);
                })
                .catch((error) => {
                    console.error('Error getting user data:', error);
                    currentUser = {
                        id: user.uid,
                        name: user.displayName || user.email.split('@')[0],
                        email: user.email,
                        phone: '',
                        photoURL: user.photoURL,
                        type: 'user',
                        phoneVerified: false,
                        emailVerified: user.emailVerified
                    };
                    
                    localStorage.setItem('aloottawa_current_user', JSON.stringify(currentUser));
                    updateUserUIMobile();
                    loadSubscriptionStatus();
                });
        }
        
        function loadUserSpecificSavingsData() {
            if (!db || !currentUser) return;
            
            db.collection('redemptions')
                .where('userId', '==', currentUser.id)
                .orderBy('date', 'desc')
                .limit(50)
                .get()
                .then((querySnapshot) => {
                    if (!querySnapshot.empty) {
                        const firestoreRedemptions = [];
                        querySnapshot.forEach((doc) => {
                            firestoreRedemptions.push(doc.data());
                        });
                        
                        if (firestoreRedemptions.length > 0) {
                            userRedemptions = firestoreRedemptions;
                            localStorage.setItem('aloottawa_user_redemptions', JSON.stringify(userRedemptions));
                            calculateTotalSavingsThisMonth();
                            updateSavingsCard();
                        }
                    }
                })
                .catch((error) => {
                    console.error('Error loading user redemptions from Firestore:', error);
                });
        }
        
        function handleUserSignedOut() {
            currentUser = null;
            isSubscribed = false;
            stripeCustomerId = null;
            localStorage.removeItem('aloottawa_current_user');
            sessionStorage.removeItem('aloottawa_current_user');
            updateUserUIMobile();
            updateSubscriptionUI();
            loadUserSavingsData();
        }
        
        function saveUserToFirestore(user) {
            db.collection('users').doc(user.id).set({
                name: user.name,
                email: user.email,
                phone: user.phone || '',
                phoneVerified: user.phoneVerified || false,
                type: user.type || 'user',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                console.log('User saved to Firestore');
            })
            .catch((error) => {
                console.error('Error saving user to Firestore:', error);
            });
        }
        
        function loadPreferences() {
            const savedLang = localStorage.getItem('aloottawa_language_mobile') || 'en';
            setLanguageMobile(savedLang);
            
            const savedLocation = localStorage.getItem('aloottawa_user_location');
            if (savedLocation) {
                try {
                    userLocation = JSON.parse(savedLocation);
                    locationFilterActive = true;
                    updateLocationStatus();
                    document.getElementById('distanceFilterMobile').style.display = 'block';
                } catch (e) {
                    console.error('Error parsing location:', e);
                }
            }
            
            const savedDistance = localStorage.getItem('aloottawa_search_radius_mobile');
            if (savedDistance) {
                currentDistance = parseInt(savedDistance);
                document.getElementById('distanceSliderMobile').value = currentDistance;
                updateDistanceValueMobile();
            }
        }
        
        function setLanguageMobile(lang) {
            currentLanguage = lang;
            
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            document.body.lang = lang;
            document.body.dir = lang === 'ar' ? 'rtl' : 'ltr';
            
            const toggleBtn = document.getElementById('languageToggleMobile');
            if (toggleBtn) {
                if (lang === 'en') {
                    toggleBtn.querySelector('.text-english').textContent = 'العربية';
                    toggleBtn.querySelector('.text-arabic').textContent = 'العربية';
                    toggleBtn.querySelector('.text-french').textContent = 'العربية';
                } else if (lang === 'ar') {
                    toggleBtn.querySelector('.text-english').textContent = 'Français';
                    toggleBtn.querySelector('.text-arabic').textContent = 'Français';
                    toggleBtn.querySelector('.text-french').textContent = 'Français';
                } else if (lang === 'fr') {
                    toggleBtn.querySelector('.text-english').textContent = 'English';
                    toggleBtn.querySelector('.text-arabic').textContent = 'English';
                    toggleBtn.querySelector('.text-french').textContent = 'English';
                }
            }
            
            updatePlaceholders();
            updateTime();
            updateLocationStatus();
            updateDistanceValueMobile();
            
            if (allDeals.length > 0) {
                displayDealsMobile();
            }
            
            updateSavingsCard();
            localStorage.setItem('aloottawa_language_mobile', lang);
            
            console.log('Language set to:', lang);
        }
        
        function toggleLanguageMobile() {
            let newLang;
            if (currentLanguage === 'en') {
                newLang = 'ar';
            } else if (currentLanguage === 'ar') {
                newLang = 'fr';
            } else {
                newLang = 'en';
            }
            setLanguageMobile(newLang);
        }
        
        function updatePlaceholders() {
            document.querySelectorAll('[data-placeholder-en]').forEach(input => {
                if (currentLanguage === 'en') {
                    input.placeholder = input.dataset.placeholderEn;
                } else if (currentLanguage === 'ar') {
                    input.placeholder = input.dataset.placeholderAr || input.dataset.placeholderEn;
                } else if (currentLanguage === 'fr') {
                    input.placeholder = input.dataset.placeholderFr || input.dataset.placeholderEn;
                }
            });
            
            document.querySelectorAll('textarea[data-placeholder-en]').forEach(textarea => {
                if (currentLanguage === 'en') {
                    textarea.placeholder = textarea.dataset.placeholderEn;
                } else if (currentLanguage === 'ar') {
                    textarea.placeholder = textarea.dataset.placeholderAr || textarea.dataset.placeholderEn;
                } else if (currentLanguage === 'fr') {
                    textarea.placeholder = textarea.dataset.placeholderFr || textarea.dataset.placeholderEn;
                }
            });
        }
        
        function updateTime() {
            const now = new Date();
            const timeString = now.getHours().toString().padStart(2, '0') + ':' + 
                              now.getMinutes().toString().padStart(2, '0');
            
            document.getElementById('timeRight').textContent = timeString;
            
            const hour = now.getHours();
            let greetingKey = 'afternoon';
            if (hour < 12) greetingKey = 'morning';
            if (hour >= 17) greetingKey = 'evening';
            
            const greetingText = languageTexts[currentLanguage].greetings[greetingKey];
            
            if (currentUser) {
                const userName = currentUser.name.split(' ')[0];
                const greeting = `${greetingText}, ${userName}!`;
                
                document.querySelectorAll('#greetingText .text-english, #greetingText .text-arabic, #greetingText .text-french').forEach(el => {
                    el.textContent = greeting;
                });
            } else {
                const greeting = `${greetingText}!`;
                document.querySelectorAll('#greetingText .text-english, #greetingText .text-arabic, #greetingText .text-french').forEach(el => {
                    el.textContent = greeting;
                });
            }
        }
        
        function updateUserUIMobile() {
            if (currentUser) {
                document.getElementById('profileSection').style.display = 'block';
                document.getElementById('loginButtonMobile').style.display = 'none';
                
                const initials = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
                document.getElementById('userAvatarMobile').textContent = initials.substring(0, 2);
                document.getElementById('userNameMobile').textContent = currentUser.name.split(' ')[0];
                document.getElementById('userEmailMobile').textContent = currentUser.email || '';
                document.getElementById('userPhoneMobile').textContent = currentUser.phone || '';
                
                updateTime();
            } else {
                document.getElementById('profileSection').style.display = 'none';
                document.getElementById('loginButtonMobile').style.display = 'block';
            }
        }
        
        function setupPhoneInput() {
            const phoneInput = document.getElementById('signupPhoneMobile');
            if (phoneInput) {
                phoneInput.addEventListener('input', function(e) {
                    this.value = this.value.replace(/[^0-9]/g, '');
                });
            }
        }
        
        // ============== DEAL FUNCTIONS ==============
        
        function openRedeemModalMobile(dealId) {
            if (!currentUser) {
                showAlertMobile(
                    currentLanguage === 'ar' ? 'الرجاء تسجيل الدخول لاستبدال العروض' : 
                    currentLanguage === 'fr' ? 'Veuillez vous connecter pour utiliser les offres' :
                    'Please login to redeem deals',
                    'warning'
                );
                openLoginModal();
                return;
            }
            
            currentRedeemDeal = allDeals.find(d => String(d.id) === String(dealId));
            if (!currentRedeemDeal) {
                showAlertMobile(
                    currentLanguage === 'ar' ? 'العرض غير متوفر' : 
                    currentLanguage === 'fr' ? 'Offre non disponible' :
                    'Deal not available',
                    'danger'
                );
                return;
            }
            
            const dealName = currentLanguage === 'ar' ? 
                (currentRedeemDeal.nameAr || currentRedeemDeal.nameEn) : 
                currentLanguage === 'fr' ?
                (currentRedeemDeal.nameFr || currentRedeemDeal.nameEn) :
                currentRedeemDeal.nameEn;
            const storeName = currentLanguage === 'ar' ? 
                (currentRedeemDeal.storeNameAr || currentRedeemDeal.storeName) : 
                currentLanguage === 'fr' ?
                (currentRedeemDeal.storeNameFr || currentRedeemDeal.storeName) :
                currentRedeemDeal.storeName;
            
            document.getElementById('redeemDealNameMobile').textContent = dealName;
            document.getElementById('redeemStoreNameMobile').textContent = storeName;
            
            document.getElementById('redeemStep1Mobile').style.display = 'block';
            document.getElementById('redeemStep2Mobile').style.display = 'none';
            document.getElementById('redeemSuccessMobile').style.display = 'none';
            
            document.querySelectorAll('.pin-input-mobile').forEach(input => {
                input.value = '';
            });
            
            document.getElementById('redeemErrorMessageMobile').classList.add('d-none');
            
            document.getElementById('redeemModalMobile').style.display = 'block';
        }
        
        function openLoginModal() {
            showLoginTabMobile();
            document.getElementById('loginModalMobile').style.display = 'block';
        }
        
        function closeLoginModalMobile() {
            document.getElementById('loginModalMobile').style.display = 'none';
            clearLoginForm();
        }
        
        function openMapModal() {
            document.getElementById('mapModalMobile').style.display = 'block';
            initializeMap();
        }
        
        function closeMapModalMobile() {
            document.getElementById('mapModalMobile').style.display = 'none';
            if (map) {
                map.remove();
                map = null;
                mapMarkers = [];
            }
        }
        
        function initializeMap() {
            if (!document.getElementById('storeMapMobile')) return;
            
            map = L.map('storeMapMobile').setView([45.4215, -75.6972], 12);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 18,
            }).addTo(map);
            
            mapMarkers.forEach(marker => map.removeLayer(marker));
            mapMarkers = [];
            
            allDeals.forEach(deal => {
                if (deal.latitude && deal.longitude) {
                    const dealName = currentLanguage === 'ar' ? 
                        (deal.nameAr || deal.nameEn) : 
                        currentLanguage === 'fr' ?
                        (deal.nameFr || deal.nameEn) :
                        deal.nameEn;
                    
                    let iconColor;
                    switch(deal.category) {
                        case 'entertainment':
                            iconColor = '#9b59b6';
                            break;
                        case 'selfcare':
                            iconColor = '#fd79a8';
                            break;
                        case 'restaurant':
                            iconColor = '#e74c3c';
                            break;
                        case 'supermarket':
                            iconColor = '#27ae60';
                            break;
                        default:
                            iconColor = '#0984e3';
                    }
                    
                    const customIcon = L.divIcon({
                        html: `<div style="background-color: ${iconColor}; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;">
                                 <i class="fas fa-map-marker-alt"></i>
                               </div>`,
                        className: 'custom-marker',
                        iconSize: [24, 24],
                        iconAnchor: [12, 24]
                    });
                    
                    const marker = L.marker([deal.latitude, deal.longitude], { icon: customIcon })
                        .addTo(map)
                        .bindPopup(`
                            <div style="min-width: 200px;">
                                <h5 style="margin: 0 0 5px; color: ${iconColor};">${dealName}</h5>
                                <p style="margin: 0 0 5px; font-size: 14px; color: #666;">
                                    <i class="fas fa-store"></i> ${deal.storeName}
                                </p>
                                <p style="margin: 0 0 10px; font-size: 13px; color: #888;">
                                    ${deal.address || ''}
                                </p>
                                <p style="margin: 0 0 10px; font-size: 14px;">
                                    <strong style="color: #e74c3c;">$${deal.price.toFixed(2)}</strong>
                                    <span style="text-decoration: line-through; color: #999; margin-left: 5px;">$${deal.oldPrice.toFixed(2)}</span>
                                </p>
                                <button onclick="openRedeemModalMobile('${deal.id}')" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; width: 100%;">
                                    <i class="fas fa-ticket-alt"></i> Redeem
                                </button>
                            </div>
                        `);
                    
                    mapMarkers.push(marker);
                }
            });
            
            if (userLocation) {
                const userIcon = L.divIcon({
                    html: `<div style="background-color: #0984e3; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-size: 14px;">
                             <i class="fas fa-user"></i>
                           </div>`,
                    className: 'user-marker',
                    iconSize: [30, 30],
                    iconAnchor: [15, 30]
                });
                
                const userMarker = L.marker([userLocation.latitude, userLocation.longitude], { icon: userIcon })
                    .addTo(map)
                    .bindPopup('Your Location')
                    .openPopup();
                
                mapMarkers.push(userMarker);
                map.setView([userLocation.latitude, userLocation.longitude], 13);
            }
        }
        
        function loadDealsMobile() {
            showLoading(true);
            
            if (db) {
                loadDealsFromFirestore();
            } else {
                loadDealsFromLocalStorage();
            }
        }
        
        function loadDealsFromFirestore() {
            db.collection('deals').where('active', '==', true).get()
                .then((querySnapshot) => {
                    allDeals = [];
                    querySnapshot.forEach((doc) => {
                        const deal = doc.data();
                        deal.id = doc.id;
                        allDeals.push(deal);
                    });
                    
                    console.log('Loaded deals from Firestore:', allDeals.length);
                    
                    if (allDeals.length === 0) {
                        loadDealsFromLocalStorage();
                    } else {
                        calculateDealRatings();
                        
                        if (userLocation) {
                            calculateDealDistances();
                        }
                        
                        filterDealsMobile(currentCategory);
                        showLoading(false);
                    }
                })
                .catch((error) => {
                    console.error('Error loading deals from Firestore:', error);
                    loadDealsFromLocalStorage();
                });
        }
        
        function loadDealsFromLocalStorage() {
            setTimeout(() => {
                const savedDeals = localStorage.getItem('aloottawa_deals');
                const savedReviews = localStorage.getItem('aloottawa_reviews');
                const savedStores = localStorage.getItem('aloottawa_stores');
                let allReviews = [];
                let allStores = [];
                
                if (savedReviews) {
                    try {
                        allReviews = JSON.parse(savedReviews);
                    } catch (e) {
                        console.error('Error parsing reviews:', e);
                    }
                }
                
                if (savedStores) {
                    try {
                        allStores = JSON.parse(savedStores);
                    } catch (e) {
                        console.error('Error parsing stores:', e);
                    }
                }
                
                if (savedDeals) {
                    try {
                        allDeals = JSON.parse(savedDeals);
                        allDeals = allDeals.filter(deal => deal.active === true);
                        
                        allDeals.forEach(deal => {
                            const dealReviews = allReviews.filter(review => review.dealId === deal.id);
                            if (dealReviews.length > 0) {
                                const totalRating = dealReviews.reduce((sum, review) => sum + review.rating, 0);
                                deal.averageRating = (totalRating / dealReviews.length).toFixed(1);
                                deal.reviewCount = dealReviews.length;
                            } else {
                                deal.averageRating = 0;
                                deal.reviewCount = 0;
                            }
                            
                            if (!deal.storeNameAr && deal.storeName) {
                                deal.storeNameAr = deal.storeName;
                            }
                            if (!deal.nameAr && deal.nameEn) {
                                deal.nameAr = deal.nameEn;
                            }
                            if (!deal.descriptionAr && deal.descriptionEn) {
                                deal.descriptionAr = deal.descriptionEn;
                            }
                            if (!deal.storeNameFr && deal.storeName) {
                                deal.storeNameFr = deal.storeName;
                            }
                            if (!deal.nameFr && deal.nameEn) {
                                deal.nameFr = deal.nameEn;
                            }
                            if (!deal.descriptionFr && deal.descriptionEn) {
                                deal.descriptionFr = deal.descriptionEn;
                            }
                            
                            if (deal.storeId && allStores.length > 0) {
                                const store = allStores.find(s => s.id === deal.storeId);
                                if (store) {
                                    deal.storeEmail = store.email;
                                    deal.storePhone = store.phone;
                                }
                            }
                        });
                        
                        console.log('Loaded deals from localStorage:', allDeals.length);
                        
                        if (allDeals.length === 0) {
                            createDemoDeals();
                        }
                        
                    } catch (e) {
                        console.error('Error parsing deals:', e);
                        allDeals = [];
                        createDemoDeals();
                    }
                } else {
                    console.log('No deals in localStorage. Creating demo deals...');
                    allDeals = [];
                    createDemoDeals();
                }
                
                if (userLocation) {
                    calculateDealDistances();
                }
                
                filterDealsMobile(currentCategory);
                showLoading(false);
            }, 500);
        }
        
        function createDemoDeals() {
            allDeals = [
                {
                    id: 1,
                    nameEn: "Welcome Deal!",
                    nameAr: "عرض ترحيبي!",
                    nameFr: "Offre de bienvenue !",
                    descriptionEn: "Try our platform with this demo offer. Add real offers from the store dashboard.",
                    descriptionAr: "جرب منصتنا مع هذا العرض التجريبي. أضف عروض حقيقية من لوحة تحكم المتاجر.",
                    descriptionFr: "Essayez notre plateforme avec cette offre de démonstration. Ajoutez de vraies offres depuis le tableau de bord du magasin.",
                    oldPrice: 20.00,
                    price: 10.00,
                    discount: 50,
                    image: "https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
                    category: "restaurant",
                    halal: true,
                    active: true,
                    storeName: "Demo Restaurant",
                    storeNameAr: "مطعم تجريبي",
                    storeNameFr: "Restaurant démo",
                    storeId: 0,
                    latitude: 45.4215,
                    longitude: -75.6972,
                    address: "123 Demo Street, Ottawa",
                    area: "Centretown",
                    redemptionCount: 0,
                    averageRating: 4.5,
                    reviewCount: 12,
                    createdAt: new Date().toISOString()
                },
                {
                    id: 2,
                    nameEn: "Weekend Special",
                    nameAr: "عرض نهاية الأسبوع",
                    nameFr: "Spécial week-end",
                    descriptionEn: "Perfect for your weekend shopping. Save big on selected items.",
                    descriptionAr: "مثالي لتسوق نهاية الأسبوع. وفر كثيراً على المنتجات المختارة.",
                    descriptionFr: "Parfait pour vos courses du week-end. Économisez beaucoup sur les articles sélectionnés.",
                    oldPrice: 100.00,
                    price: 70.00,
                    discount: 30,
                    image: "https://images.unsplash.com/photo-1556909114-f6e7ad7d3136?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
                    category: "supermarket",
                    halal: true,
                    active: true,
                    storeName: "Demo Supermarket",
                    storeNameAr: "سوبرماركت تجريبي",
                    storeNameFr: "Supermarché démo",
                    storeId: 0,
                    latitude: 45.4115,
                    longitude: -75.7072,
                    address: "456 Market Ave, Ottawa",
                    area: "ByWard Market",
                    redemptionCount: 0,
                    averageRating: 4.2,
                    reviewCount: 8,
                    createdAt: new Date().toISOString()
                },
                {
                    id: 3,
                    nameEn: "Movie Night Special",
                    nameAr: "عرض ليلة سينما",
                    nameFr: "Spécial soirée cinéma",
                    descriptionEn: "2 movie tickets + popcorn & drinks for a special price. Perfect for family night out.",
                    descriptionAr: "تذكرتي سينما + فشار ومشروبات بسعر خاص. مثالي لليلة عائلية.",
                    descriptionFr: "2 billets de cinéma + popcorn & boissons à prix spécial. Parfait pour une soirée en famille.",
                    oldPrice: 40.00,
                    price: 25.00,
                    discount: 38,
                    image: "https://images.unsplash.com/photo-1536440136628-849c177e76a1?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
                    category: "entertainment",
                    halal: true,
                    active: true,
                    storeName: "Ottawa Cineplex",
                    storeNameAr: "سينيبلكس أوتاوا",
                    storeNameFr: "Cineplex Ottawa",
                    storeId: 0,
                    latitude: 45.4280,
                    longitude: -75.6900,
                    address: "789 Cinema Road, Ottawa",
                    area: "Rideau Centre",
                    redemptionCount: 0,
                    averageRating: 4.7,
                    reviewCount: 25,
                    createdAt: new Date().toISOString()
                },
                {
                    id: 4,
                    nameEn: "Spa & Relaxation Package",
                    nameAr: "باقة سبا واسترخاء",
                    nameFr: "Forfait spa & relaxation",
                    descriptionEn: "Full body massage + facial treatment + sauna access. Rejuvenate yourself!",
                    descriptionAr: "مساج كامل للجسم + علاج للوجه + دخول الساونا. انعش نفسك!",
                    descriptionFr: "Massage complet du corps + soin du visage + accès au sauna. Régénerez-vous !",
                    oldPrice: 150.00,
                    price: 99.00,
                    discount: 34,
                    image: "https://images.unsplash.com/photo-1544161515-4ab6ce6db874?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
                    category: "selfcare",
                    halal: true,
                    active: true,
                    storeName: "Serenity Spa",
                    storeNameAr: "سبا سيرينيتي",
                    storeNameFr: "Spa Sérénité",
                    storeId: 0,
                    latitude: 45.4250,
                    longitude: -75.6800,
                    address: "321 Wellness Blvd, Ottawa",
                    area: "Westboro",
                    redemptionCount: 0,
                    averageRating: 4.9,
                    reviewCount: 18,
                    createdAt: new Date().toISOString()
                }
            ];
            
            localStorage.setItem('aloottawa_deals', JSON.stringify(allDeals));
            console.log('Demo deals created and saved including new categories');
        }
        
        function filterDealsMobile(category) {
            currentCategory = category;
            
            document.querySelectorAll('.category-card').forEach(card => {
                if (card.dataset.category === category) {
                    card.classList.add('active');
                } else {
                    card.classList.remove('active');
                }
            });
            
            if (category === 'all') {
                filteredDeals = [...allDeals];
            } else {
                filteredDeals = allDeals.filter(deal => deal.category === category);
            }
            
            if (locationFilterActive && userLocation) {
                filteredDeals = filteredDeals.filter(deal => 
                    deal.distance !== null && deal.distance <= currentDistance
                );
                
                filteredDeals.sort((a, b) => {
                    if (a.distance === null) return 1;
                    if (b.distance === null) return -1;
                    return a.distance - b.distance;
                });
            }
            
            displayDealsMobile();
        }
        
        function displayDealsMobile() {
            const container = document.getElementById('dealsContainerMobile');
            const noDealsMessage = document.getElementById('noDealsMessageMobile');
            const dealsCount = document.getElementById('dealsCount');
            const viewAllBtn = document.getElementById('viewAllDealsBtn');
            
            if (dealsCount) {
                if (currentLanguage === 'en') {
                    dealsCount.textContent = `${filteredDeals.length} deals available`;
                } else if (currentLanguage === 'ar') {
                    dealsCount.textContent = `${filteredDeals.length} عرض متاح`;
                } else if (currentLanguage === 'fr') {
                    dealsCount.textContent = `${filteredDeals.length} offres disponibles`;
                }
            }
            
            if (filteredDeals.length === 0) {
                container.innerHTML = '';
                noDealsMessage.style.display = 'block';
                viewAllBtn.style.display = 'none';
                return;
            }
            
            noDealsMessage.style.display = 'none';
            
            if (filteredDeals.length > dealsToShowLimit) {
                viewAllBtn.style.display = 'block';
            } else {
                viewAllBtn.style.display = 'none';
            }
            
            const dealsToShow = filteredDeals.slice(0, dealsToShowLimit);
            
            let dealsHTML = '';
            
            dealsToShow.forEach(deal => {
                const dealImage = deal.image || 'https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80';
                
                const dealName = currentLanguage === 'ar' ? (deal.nameAr || deal.nameEn) : 
                                currentLanguage === 'fr' ? (deal.nameFr || deal.nameEn) : 
                                deal.nameEn;
                const storeName = currentLanguage === 'ar' ? (deal.storeNameAr || deal.storeName) : 
                                 currentLanguage === 'fr' ? (deal.storeNameFr || deal.storeName) : 
                                 deal.storeName;
                const dealDescription = currentLanguage === 'ar' ? (deal.descriptionAr || deal.descriptionEn) : 
                                       currentLanguage === 'fr' ? (deal.descriptionFr || deal.descriptionEn) : 
                                       deal.descriptionEn;
                const halalText = currentLanguage === 'ar' ? 'حلال' : 
                                 currentLanguage === 'fr' ? 'Halal' : 
                                 'Halal';
                const redeemText = currentLanguage === 'ar' ? 'استبدال' : 
                                  currentLanguage === 'fr' ? 'Utiliser' : 
                                  'Redeem';
                const kmText = currentLanguage === 'ar' ? 'كم' : 'km';
                const areaText = deal.area || '';
                
                let categoryBadgeClass = '';
                if (deal.category === 'entertainment') {
                    categoryBadgeClass = 'entertainment-badge';
                } else if (deal.category === 'selfcare') {
                    categoryBadgeClass = 'selfcare-badge';
                } else if (deal.category === 'restaurant') {
                    categoryBadgeClass = 'restaurant-badge';
                } else if (deal.category === 'supermarket') {
                    categoryBadgeClass = 'supermarket-badge';
                }
                
                let categoryBadgeText = '';
                if (deal.category === 'entertainment') {
                    categoryBadgeText = currentLanguage === 'ar' ? 'ترفيه' : 
                                       currentLanguage === 'fr' ? 'Divertissement' : 
                                       'Entertainment';
                } else if (deal.category === 'selfcare') {
                    categoryBadgeText = currentLanguage === 'ar' ? 'عناية ذاتية' : 
                                       currentLanguage === 'fr' ? 'Soins personnels' : 
                                       'Self Care';
                } else if (deal.category === 'restaurant') {
                    categoryBadgeText = currentLanguage === 'ar' ? 'مطعم' : 
                                       currentLanguage === 'fr' ? 'Restaurant' : 
                                       'Restaurant';
                } else if (deal.category === 'supermarket') {
                    categoryBadgeText = currentLanguage === 'ar' ? 'سوبرماركت' : 
                                       currentLanguage === 'fr' ? 'Supermarché' : 
                                       'Supermarket';
                }
                
                let ratingHTML = '';
                if (deal.averageRating > 0) {
                    const fullStars = Math.floor(deal.averageRating);
                    const hasHalfStar = deal.averageRating % 1 >= 0.5;
                    
                    ratingHTML = `
                        <div class="deal-rating">
                            <div class="rating-stars">
                                ${'★'.repeat(fullStars)}${hasHalfStar ? '½' : ''}${'☆'.repeat(5 - fullStars - (hasHalfStar ? 1 : 0))}
                            </div>
                            <span class="rating-count">${deal.averageRating} (${deal.reviewCount || 0})</span>
                        </div>
                    `;
                }
                
                let distanceHTML = '';
                if (deal.distance !== null && deal.distance !== undefined) {
                    distanceHTML = `
                        <div class="deal-distance">
                            <i class="fas fa-map-marker-alt"></i>
                            ${deal.distance} ${kmText}
                        </div>
                    `;
                }
                
                const dealCardClass = 'deal-card-mobile';
                
                dealsHTML += `
                    <div class="${dealCardClass} ${deal.category}">
                        <div class="deal-badge">${deal.discount}% OFF</div>
                        ${categoryBadgeText ? `<span class="category-badge ${categoryBadgeClass}">${categoryBadgeText}</span>` : ''}
                        
                        <div class="deal-image-container">
                            <img src="${dealImage}" alt="${dealName}" class="deal-image"
                                 onerror="this.src='https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80'">
                        </div>
                        
                        <h5 class="deal-title">${dealName}</h5>
                        <div class="deal-store">
                            <i class="fas fa-store"></i> ${storeName}
                        </div>
                        
                        ${areaText ? `<span class="store-area">${areaText}</span>` : ''}
                        
                        <p class="deal-description">${dealDescription}</p>
                        
                        <div class="deal-price-container">
                            <div class="deal-price">
                                <span class="old-price">$${deal.oldPrice.toFixed(2)}</span>
                                <span class="new-price">$${deal.price.toFixed(2)}</span>
                            </div>
                            ${distanceHTML}
                        </div>
                        
                        ${ratingHTML}
                        
                        ${deal.halal ? `<span class="halal-badge"><i class="fas fa-check-circle"></i> ${halalText}</span>` : ''}
                        
                        <div class="deal-actions">
                            <button class="redeem-btn" onclick="openRedeemModalMobile('${deal.id}')">
                                <i class="fas fa-ticket-alt"></i> ${redeemText}
                            </button>
                            <button class="details-btn" onclick="showDealDetails('${deal.id}')">
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = dealsHTML;
        }
        
        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
        }
        
        function showAlertMobile(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-mobile mb-0`;
            alertDiv.textContent = message;
            
            document.getElementById('alertMobile').appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }
        
        function loginUserMobile() {
            if (!auth) {
                showModalErrorMobile(
                    currentLanguage === 'ar' ? 'خدمة المصادقة غير متوفرة' : 
                    currentLanguage === 'fr' ? 'Service d\'authentification non disponible' :
                    'Authentication service not available',
                    'login'
                );
                return;
            }
            
            const email = document.getElementById('loginEmailMobile').value.trim();
            const password = document.getElementById('loginPasswordMobile').value;
            const rememberMe = document.getElementById('rememberMeMobile').checked;
            
            if (!email || !password) {
                showModalErrorMobile(
                    currentLanguage === 'ar' ? 'الرجاء إدخال البريد الإلكتروني وكلمة المرور' : 
                    currentLanguage === 'fr' ? 'Veuillez saisir l\'email et le mot de passe' :
                    'Please enter email and password',
                    'login'
                );
                return;
            }
            
            const loginBtn = document.querySelector('#loginTabMobile .btn-primary');
            const originalText = loginBtn.innerHTML;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            loginBtn.disabled = true;
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    console.log('User logged in:', user.email);
                    
                    if (rememberMe) {
                        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                    } else {
                        auth.setPersistence(firebase.auth.Auth.Persistence.SESSION);
                    }
                    
                    closeLoginModalMobile();
                    showAlertMobile(
                        languageTexts[currentLanguage].alerts.loginSuccess.replace('{name}', user.displayName || user.email.split('@')[0]),
                        'success'
                    );
                })
                .catch((error) => {
                    console.error('Login error:', error);
                    let errorMessage = getFirebaseErrorMessage(error, currentLanguage);
                    showModalErrorMobile(errorMessage, 'login');
                    
                    loginBtn.innerHTML = originalText;
                    loginBtn.disabled = false;
                });
        }
        
        function signupUserMobile() {
            if (!auth) {
                showModalErrorMobile(
                    currentLanguage === 'ar' ? 'خدمة المصادقة غير متوفرة' : 
                    currentLanguage === 'fr' ? 'Service d\'authentification non disponible' :
                    'Authentication service not available',
                    'signup'
                );
                return;
            }
            
            const name = document.getElementById('signupNameMobile').value.trim();
            const email = document.getElementById('signupEmailMobile').value.trim();
            const countryCode = document.getElementById('signupCountryCodeMobile').value;
            const phone = document.getElementById('signupPhoneMobile').value.trim();
            const password = document.getElementById('signupPasswordMobile').value;
            const confirmPassword = document.getElementById('signupConfirmPasswordMobile').value;
            const agreeTerms = document.getElementById('agreeTermsMobile').checked;
            
            if (!name) {
                showModalErrorMobile(
                    currentLanguage === 'ar' ? 'الرجاء إدخال الاسم' : 
                    currentLanguage === 'fr' ? 'Veuillez saisir votre nom' :
                    'Please enter your name',
                    'signup'
                );
                return;
            }
            
            if (!email) {
                showModalErrorMobile(
                    currentLanguage === 'ar' ? 'الرجاء إدخال البريد الإلكتروني' : 
                    currentLanguage === 'fr' ? 'Veuillez saisir l\'email' :
                    'Please enter email',
                    'signup'
                );
                return;
            }
            
            if (!password || !confirmPassword) {
                showModalErrorMobile(
                    currentLanguage === 'ar' ? 'الرجاء إدخال كلمة المرور' : 
                    currentLanguage === 'fr' ? 'Veuillez saisir le mot de passe' :
                    'Please enter password',
                    'signup'
                );
                return;
            }
            
            if (password !== confirmPassword) {
                showModalErrorMobile(
                    currentLanguage === 'ar' ? 'كلمات المرور غير متطابقة' : 
                    currentLanguage === 'fr' ? 'Les mots de passe ne correspondent pas' :
                    'Passwords do not match',
                    'signup'
                );
                return;
            }
            
            if (password.length < 6) {
                showModalErrorMobile(
                    currentLanguage === 'ar' ? 'كلمة المرور يجب أن تكون 6 أحرف على الأقل' : 
                    currentLanguage === 'fr' ? 'Le mot de passe doit contenir au moins 6 caractères' :
                    'Password must be at least 6 characters',
                    'signup'
                );
                return;
            }
            
            if (!agreeTerms) {
                showModalErrorMobile(
                    currentLanguage === 'ar' ? 'الرجاء الموافقة على الشروط' : 
                    currentLanguage === 'fr' ? 'Veuillez accepter les conditions' :
                    'Please agree to terms',
                    'signup'
                );
                return;
            }
            
            const signupBtn = document.querySelector('#signupTabMobile .btn-success');
            const originalText = signupBtn.innerHTML;
            signupBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
            signupBtn.disabled = true;
            
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    
                    return user.updateProfile({
                        displayName: name
                    }).then(() => {
                        const userData = {
                            name: name,
                            email: email,
                            phone: phone ? countryCode + phone : '',
                            phoneVerified: false,
                            type: 'user',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        return db.collection('users').doc(user.uid).set(userData);
                    });
                })
                .then(() => {
                    return auth.currentUser.sendEmailVerification();
                })
                .then(() => {
                    closeLoginModalMobile();
                    showAlertMobile(
                        languageTexts[currentLanguage].alerts.signupSuccess.replace('{name}', name),
                        'success'
                    );
                })
                .catch((error) => {
                    console.error('Signup error:', error);
                    let errorMessage = getFirebaseErrorMessage(error, currentLanguage);
                    showModalErrorMobile(errorMessage, 'signup');
                    
                    signupBtn.innerHTML = originalText;
                    signupBtn.disabled = false;
                });
        }
        
        function getFirebaseErrorMessage(error, language) {
            let message = '';
            
            switch (error.code) {
                case 'auth/invalid-email':
                    message = language === 'ar' ? 'بريد إلكتروني غير صحيح' : 
                              language === 'fr' ? 'Email invalide' :
                              'Invalid email';
                    break;
                case 'auth/user-disabled':
                    message = language === 'ar' ? 'تم تعطيل هذا الحساب' : 
                              language === 'fr' ? 'Ce compte a été désactivé' :
                              'This account has been disabled';
                    break;
                case 'auth/user-not-found':
                    message = language === 'ar' ? 'لم يتم العثور على مستخدم بهذا البريد' : 
                              language === 'fr' ? 'Aucun utilisateur trouvé avec cet email' :
                              'No user found with this email';
                    break;
                case 'auth/wrong-password':
                    message = language === 'ar' ? 'كلمة المرور غير صحيحة' : 
                              language === 'fr' ? 'Mot de passe incorrect' :
                              'Wrong password';
                    break;
                case 'auth/email-already-in-use':
                    message = language === 'ar' ? 'البريد الإلكتروني مستخدم بالفعل' : 
                              language === 'fr' ? 'Email déjà utilisé' :
                              'Email already in use';
                    break;
                case 'auth/weak-password':
                    message = language === 'ar' ? 'كلمة المرور ضعيفة' : 
                              language === 'fr' ? 'Mot de passe trop faible' :
                              'Password is too weak';
                    break;
                case 'auth/operation-not-allowed':
                    message = language === 'ar' ? 'هذه العملية غير مسموح بها' : 
                              language === 'fr' ? 'Cette opération n\'est pas autorisée' :
                              'Operation not allowed';
                    break;
                case 'auth/too-many-requests':
                    message = language === 'ar' ? 'طلبات كثيرة جداً، حاول لاحقاً' : 
                              language === 'fr' ? 'Trop de requêtes, réessayez plus tard' :
                              'Too many requests, try again later';
                    break;
                case 'auth/invalid-phone-number':
                    message = language === 'ar' ? 'رقم هاتف غير صحيح' : 
                              language === 'fr' ? 'Numéro de téléphone invalide' :
                              'Invalid phone number';
                    break;
                case 'auth/captcha-check-failed':
                    message = language === 'ar' ? 'فشل التحقق من CAPTCHA' : 
                              language === 'fr' ? 'Échec de la vérification CAPTCHA' :
                              'CAPTCHA verification failed';
                    break;
                default:
                    message = language === 'ar' ? 'حدث خطأ غير متوقع' : 
                              language === 'fr' ? 'Une erreur inattendue s\'est produite' :
                              'An unexpected error occurred';
                    break;
            }
            
            return languageTexts[language].alerts.firebaseError.replace('{error}', message);
        }
        
        function showModalErrorMobile(message, type) {
            const errorDiv = document.getElementById(`${type}ErrorMessageMobile`);
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.classList.remove('d-none');
            }
        }
        
        function showLoginTabMobile() {
            document.getElementById('loginTabMobile').style.display = 'block';
            document.getElementById('signupTabMobile').style.display = 'none';
            document.getElementById('forgotPasswordTabMobile').style.display = 'none';
            document.getElementById('phoneLoginTabMobile').style.display = 'none';
            
            document.getElementById('loginErrorMessageMobile').classList.add('d-none');
        }
        
        function showSignupTabMobile() {
            document.getElementById('loginTabMobile').style.display = 'none';
            document.getElementById('signupTabMobile').style.display = 'block';
            document.getElementById('forgotPasswordTabMobile').style.display = 'none';
            document.getElementById('phoneLoginTabMobile').style.display = 'none';
            
            document.getElementById('signupErrorMessageMobile').classList.add('d-none');
        }
        
        function showForgotPasswordMobile() {
            document.getElementById('loginTabMobile').style.display = 'none';
            document.getElementById('signupTabMobile').style.display = 'none';
            document.getElementById('forgotPasswordTabMobile').style.display = 'block';
            document.getElementById('phoneLoginTabMobile').style.display = 'none';
        }
        
        function resetPasswordMobile() {
            const email = document.getElementById('forgotPasswordEmailMobile').value.trim();
            
            if (!email) {
                document.getElementById('forgotPasswordErrorMessageMobile').textContent = 
                    currentLanguage === 'ar' ? 'الرجاء إدخال البريد الإلكتروني' : 
                    currentLanguage === 'fr' ? 'Veuillez saisir votre email' :
                    'Please enter your email';
                document.getElementById('forgotPasswordErrorMessageMobile').classList.remove('d-none');
                return;
            }
            
            const resetBtn = document.querySelector('#forgotPasswordTabMobile .btn-primary');
            const originalText = resetBtn.innerHTML;
            resetBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
            resetBtn.disabled = true;
            
            auth.sendPasswordResetEmail(email)
                .then(() => {
                    document.getElementById('forgotPasswordSuccessMessageMobile').textContent = 
                        currentLanguage === 'ar' ? 'تم إرسال رابط إعادة تعيين كلمة المرور إلى بريدك الإلكتروني' : 
                        currentLanguage === 'fr' ? 'Lien de réinitialisation du mot de passe envoyé à votre email' :
                        'Password reset email sent';
                    document.getElementById('forgotPasswordSuccessMessageMobile').classList.remove('d-none');
                    document.getElementById('forgotPasswordErrorMessageMobile').classList.add('d-none');
                    
                    resetBtn.innerHTML = originalText;
                    resetBtn.disabled = false;
                    
                    setTimeout(() => {
                        showLoginTabMobile();
                    }, 3000);
                })
                .catch((error) => {
                    console.error('Password reset error:', error);
                    let errorMessage = getFirebaseErrorMessage(error, currentLanguage);
                    document.getElementById('forgotPasswordErrorMessageMobile').textContent = errorMessage;
                    document.getElementById('forgotPasswordErrorMessageMobile').classList.remove('d-none');
                    
                    resetBtn.innerHTML = originalText;
                    resetBtn.disabled = false;
                });
        }
        
        function clearLoginForm() {
            document.getElementById('loginEmailMobile').value = '';
            document.getElementById('loginPasswordMobile').value = '';
            document.getElementById('signupNameMobile').value = '';
            document.getElementById('signupEmailMobile').value = '';
            document.getElementById('signupPhoneMobile').value = '';
            document.getElementById('signupPasswordMobile').value = '';
            document.getElementById('signupConfirmPasswordMobile').value = '';
            document.getElementById('agreeTermsMobile').checked = false;
            document.getElementById('forgotPasswordEmailMobile').value = '';
            document.getElementById('phoneLoginNumberMobile').value = '';
            
            document.getElementById('loginErrorMessageMobile').classList.add('d-none');
            document.getElementById('signupErrorMessageMobile').classList.add('d-none');
            document.getElementById('forgotPasswordErrorMessageMobile').classList.add('d-none');
            document.getElementById('forgotPasswordSuccessMessageMobile').classList.add('d-none');
            document.getElementById('phoneLoginErrorMessageMobile').classList.add('d-none');
        }
        
        function calculateDealDistances() {
            if (!userLocation) return;
            
            allDeals.forEach(deal => {
                if (deal.latitude && deal.longitude) {
                    deal.distance = calculateDistance(
                        userLocation.latitude,
                        userLocation.longitude,
                        deal.latitude,
                        deal.longitude
                    );
                } else {
                    deal.distance = null;
                }
            });
        }
        
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c;
            return Math.round(distance * 10) / 10;
        }
        
        function calculateDealRatings() {
            if (db) {
                db.collection('reviews').get()
                    .then((querySnapshot) => {
                        const reviewsByDeal = {};
                        querySnapshot.forEach((doc) => {
                            const review = doc.data();
                            const dealId = review.dealId;
                            if (!reviewsByDeal[dealId]) {
                                reviewsByDeal[dealId] = [];
                            }
                            reviewsByDeal[dealId].push(review);
                        });
                        
                        allDeals.forEach(deal => {
                            const dealReviews = reviewsByDeal[deal.id] || [];
                            if (dealReviews.length > 0) {
                                const totalRating = dealReviews.reduce((sum, review) => sum + review.rating, 0);
                                deal.averageRating = (totalRating / dealReviews.length).toFixed(1);
                                deal.reviewCount = dealReviews.length;
                            } else {
                                deal.averageRating = 0;
                                deal.reviewCount = 0;
                            }
                        });
                    })
                    .catch((error) => {
                        console.error('Error loading reviews:', error);
                    });
            }
        }
        
        function getUserLocationMobile() {
            if (!navigator.geolocation) {
                showAlertMobile(
                    currentLanguage === 'ar' ? 'تحديد الموقع غير مدعوم' : 
                    currentLanguage === 'fr' ? 'Géolocalisation non prise en charge' :
                    'Geolocation not supported', 
                    'warning'
                );
                return;
            }
            
            const statusEl = document.getElementById('locationStatusMobile');
            const statusText = currentLanguage === 'ar' ? 'جاري تحديد موقعك...' :
                              currentLanguage === 'fr' ? 'Détection de votre position...' :
                              'Detecting your location...';
            
            statusEl.querySelector('.text-english').textContent = statusText;
            statusEl.querySelector('.text-arabic').textContent = statusText;
            statusEl.querySelector('.text-french').textContent = statusText;
            
            document.getElementById('locationStatusMobile').className = 'location-status text-warning';
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                    
                    locationFilterActive = true;
                    updateLocationStatus();
                    
                    document.getElementById('distanceFilterMobile').style.display = 'block';
                    
                    calculateDealDistances();
                    filterDealsMobile(currentCategory);
                    
                    localStorage.setItem('aloottawa_user_location', JSON.stringify(userLocation));
                    
                    showAlertMobile(languageTexts[currentLanguage].alerts.locationFound, 'success');
                },
                (error) => {
                    let errorMsg = currentLanguage === 'ar' ? 'خطأ في تحديد الموقع' : 
                                   currentLanguage === 'fr' ? 'Erreur de localisation' :
                                   'Error getting location';
                    if (error.code === error.PERMISSION_DENIED) {
                        errorMsg = currentLanguage === 'ar' ? 'تم رفض إذن الموقع' : 
                                   currentLanguage === 'fr' ? 'Permission de localisation refusée' :
                                   'Location permission denied';
                    }
                    
                    statusEl.querySelector('.text-english').textContent = errorMsg;
                    statusEl.querySelector('.text-arabic').textContent = errorMsg;
                    statusEl.querySelector('.text-french').textContent = errorMsg;
                    
                    document.getElementById('locationStatusMobile').className = 'location-status text-danger';
                    
                    showAlertMobile(errorMsg, 'danger');
                }
            );
        }
        
        function updateLocationStatus() {
            const statusEl = document.getElementById('locationStatusMobile');
            
            if (locationFilterActive && userLocation) {
                const statusText = currentLanguage === 'ar' ? `الموقع مفعل • عرض عروض ضمن ${currentDistance} كم` :
                                  currentLanguage === 'fr' ? `Localisation activée • Affichage des offres dans un rayon de ${currentDistance} km` :
                                  `Location enabled • Showing deals within ${currentDistance} km`;
                
                statusEl.querySelector('.text-english').textContent = statusText;
                statusEl.querySelector('.text-arabic').textContent = statusText;
                statusEl.querySelector('.text-french').textContent = statusText;
                document.getElementById('locationStatusMobile').className = 'location-status success';
            } else {
                const statusText = currentLanguage === 'ar' ? 'انقر على "تحديد الموقع" للعثور على عروض قريبة منك' :
                                  currentLanguage === 'fr' ? 'Cliquez sur "Localiser" pour trouver des offres près de vous' :
                                  'Click "Locate" to find deals near you';
                
                statusEl.querySelector('.text-english').textContent = statusText;
                statusEl.querySelector('.text-arabic').textContent = statusText;
                statusEl.querySelector('.text-french').textContent = statusText;
                document.getElementById('locationStatusMobile').className = 'location-status';
            }
        }
        
        function updateDistanceValueMobile() {
            const slider = document.getElementById('distanceSliderMobile');
            const valueEl = document.getElementById('distanceValueMobile');
            
            currentDistance = parseInt(slider.value);
            const kmText = currentLanguage === 'ar' ? 'كم' : 'km';
            valueEl.textContent = `${currentDistance} ${kmText}`;
            
            localStorage.setItem('aloottawa_search_radius_mobile', currentDistance);
            
            if (locationFilterActive && userLocation) {
                filterDealsMobile(currentCategory);
                updateLocationStatus();
            }
        }
        
        function verifyPinMobile() {
            const pinInputs = document.querySelectorAll('.pin-input-mobile');
            const enteredPin = Array.from(pinInputs).map(input => input.value).join('');
            
            if (enteredPin.length !== 4) {
                showRedeemErrorMobile(
                    currentLanguage === 'ar' ? 'الرجاء إدخال رمز مكون من 4 أرقام' : 
                    currentLanguage === 'fr' ? 'Veuillez entrer un code à 4 chiffres' :
                    'Please enter 4-digit PIN'
                );
                return;
            }
            
            if (!/^[1-6]{4}$/.test(enteredPin)) {
                showRedeemErrorMobile(
                    currentLanguage === 'ar' ? 'رمز PIN غير صحيح' : 
                    currentLanguage === 'fr' ? 'Code PIN invalide' :
                    'Invalid PIN code'
                );
                return;
            }
            
            generatedCode = generateCode();
            
            document.getElementById('redeemStep1Mobile').style.display = 'none';
            document.getElementById('redeemStep2Mobile').style.display = 'block';
            
            document.getElementById('generatedCodeMobile').textContent = generatedCode;
            
            startCodeTimerMobile(5);
            
            showAlertMobile(languageTexts[currentLanguage].alerts.codeGenerated, 'success');
        }
        
        function generateCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 7; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
                if (i === 3) code += '-';
            }
            return code;
        }
        
        function startCodeTimerMobile(minutes) {
            let timeLeft = minutes * 60;
            updateTimerDisplayMobile(timeLeft);
            
            if (codeExpiryTimer) clearInterval(codeExpiryTimer);
            
            codeExpiryTimer = setInterval(() => {
                timeLeft--;
                
                if (timeLeft <= 0) {
                    clearInterval(codeExpiryTimer);
                    showRedeemErrorMobile(
                        currentLanguage === 'ar' ? 'انتهت صلاحية الرمز. الرجاء المحاولة مرة أخرى' : 
                        currentLanguage === 'fr' ? 'Code expiré. Veuillez réessayer' :
                        'Code expired. Please try again'
                    );
                    setTimeout(() => {
                        closeRedeemModalMobile();
                    }, 2000);
                } else {
                    updateTimerDisplayMobile(timeLeft);
                }
            }, 1000);
        }
        
        function updateTimerDisplayMobile(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            const timerValue = document.getElementById('timerValueMobile');
            
            timerValue.textContent = `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            
            if (seconds < 60) {
                timerValue.style.color = '#d63031';
            } else if (seconds < 120) {
                timerValue.style.color = '#fdcb6e';
            } else {
                timerValue.style.color = '#00b894';
            }
        }
        
        function showRedeemErrorMobile(message) {
            const errorDiv = document.getElementById('redeemErrorMessageMobile');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.classList.remove('d-none');
            }
        }
        
        function closeRedeemModalMobile() {
            document.getElementById('redeemModalMobile').style.display = 'none';
            currentRedeemDeal = null;
            generatedCode = null;
            
            if (codeExpiryTimer) {
                clearInterval(codeExpiryTimer);
                codeExpiryTimer = null;
            }
        }
        
        function completeRedemptionMobile() {
            if (codeExpiryTimer) {
                clearInterval(codeExpiryTimer);
                codeExpiryTimer = null;
            }
            
            const amountSaved = currentRedeemDeal.oldPrice - currentRedeemDeal.price;
            
            recordRedemption();
            addRedemptionToSavings(currentRedeemDeal, amountSaved);
            
            document.getElementById('redeemStep2Mobile').style.display = 'none';
            document.getElementById('redeemSuccessMobile').style.display = 'block';
            
            const dealName = currentLanguage === 'ar' ? 
                (currentRedeemDeal.nameAr || currentRedeemDeal.nameEn) : 
                currentLanguage === 'fr' ?
                (currentRedeemDeal.nameFr || currentRedeemDeal.nameEn) :
                currentRedeemDeal.nameEn;
            const storeName = currentLanguage === 'ar' ? 
                (currentRedeemDeal.storeNameAr || currentRedeemDeal.storeName) : 
                currentLanguage === 'fr' ?
                (currentRedeemDeal.storeNameFr || currentRedeemDeal.storeName) :
                currentRedeemDeal.storeName;
            
            const successMessage = currentLanguage === 'ar' ?
                `تم استبدال "${dealName}" في ${storeName} بنجاح! وفرت $${amountSaved.toFixed(2)}` :
                currentLanguage === 'fr' ?
                `"${dealName}" utilisé avec succès chez ${storeName} ! Vous avez économisé $${amountSaved.toFixed(2)}` :
                `Successfully redeemed "${dealName}" at ${storeName}! You saved $${amountSaved.toFixed(2)}`;
            
            document.getElementById('redeemSuccessMessageMobile').textContent = successMessage;
            
            showAlertMobile(
                languageTexts[currentLanguage].alerts.dealRedeemed.replace('${savings}', amountSaved.toFixed(2)),
                'success'
            );
        }
        
        function recordRedemption() {
            const redemptionRecord = {
                dealId: currentRedeemDeal.id,
                dealName: currentLanguage === 'ar' ? (currentRedeemDeal.nameAr || currentRedeemDeal.nameEn) : 
                         currentLanguage === 'fr' ? (currentRedeemDeal.nameFr || currentRedeemDeal.nameEn) :
                         currentRedeemDeal.nameEn,
                storeName: currentLanguage === 'ar' ? (currentRedeemDeal.storeNameAr || currentRedeemDeal.storeName) : 
                          currentLanguage === 'fr' ? (currentRedeemDeal.storeNameFr || currentRedeemDeal.storeName) :
                          currentRedeemDeal.storeName,
                customerId: currentUser.id,
                customerName: currentUser.name,
                customerEmail: currentUser.email,
                customerPhone: currentUser.phone,
                redeemedAt: new Date().toISOString(),
                code: generatedCode,
                status: 'completed',
                amountSaved: currentRedeemDeal.oldPrice - currentRedeemDeal.price,
                originalPrice: currentRedeemDeal.oldPrice,
                paidPrice: currentRedeemDeal.price,
                discount: currentRedeemDeal.discount
            };
            
            if (db) {
                db.collection('redemptions').add(redemptionRecord)
                    .then((docRef) => {
                        console.log('Redemption saved to Firestore:', docRef.id);
                    })
                    .catch((error) => {
                        console.error('Error saving redemption to Firestore:', error);
                        saveRedemptionToLocalStorage(redemptionRecord);
                    });
            } else {
                saveRedemptionToLocalStorage(redemptionRecord);
            }
        }
        
        function saveRedemptionToLocalStorage(redemptionRecord) {
            const savedRedemptions = localStorage.getItem('aloottawa_redemptions_mobile');
            let allRedemptions = savedRedemptions ? JSON.parse(savedRedemptions) : [];
            redemptionRecord.id = allRedemptions.length + 1;
            allRedemptions.push(redemptionRecord);
            localStorage.setItem('aloottawa_redemptions_mobile', JSON.stringify(allRedemptions));
        }
        
        function moveToNextMobile(input, nextIndex) {
            if (input.value.length === 1) {
                const nextInput = document.querySelectorAll('.pin-input-mobile')[nextIndex - 1];
                if (nextInput) {
                    nextInput.focus();
                }
            }
        }
        
        function handlePinBackspaceMobile(event, currentIndex) {
            if (event.key === 'Backspace' && !event.target.value) {
                const prevInput = document.querySelectorAll('.pin-input-mobile')[currentIndex - 2];
                if (prevInput) {
                    prevInput.focus();
                }
            }
        }
        
        function setupRatingStarsMobile() {
            const starsContainer = document.getElementById('ratingStarsContainerMobile');
            if (starsContainer) {
                const stars = starsContainer.querySelectorAll('.rating-star-mobile');
                stars.forEach(star => {
                    star.addEventListener('click', () => {
                        const rating = parseInt(star.dataset.rating);
                        setRatingMobile(rating);
                    });
                });
            }
        }
        
        function setRatingMobile(rating) {
            currentRating = rating;
            const stars = document.querySelectorAll('.rating-star-mobile');
            
            stars.forEach(star => {
                const starRating = parseInt(star.dataset.rating);
                if (starRating <= rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
            
            const ratingText = document.getElementById('ratingTextMobile');
            const ratingTextEn = ratingText.querySelector('.text-english');
            const ratingTextAr = ratingText.querySelector('.text-arabic');
            const ratingTextFr = ratingText.querySelector('.text-french');
            
            if (ratingTextEn && ratingTextAr && ratingTextFr) {
                if (currentLanguage === 'en') {
                    ratingTextEn.textContent = languageTexts.en.ratingTexts[rating] || 'Click on stars to rate';
                } else if (currentLanguage === 'ar') {
                    ratingTextAr.textContent = languageTexts.ar.ratingTexts[rating] || 'انقر على النجوم للتقييم';
                } else if (currentLanguage === 'fr') {
                    ratingTextFr.textContent = languageTexts.fr.ratingTexts[rating] || 'Cliquez sur les étoiles pour évaluer';
                }
            }
        }
        
        function openRatingModalMobile() {
            if (!currentRedeemDeal) return;
            
            const dealName = currentLanguage === 'ar' ? 
                (currentRedeemDeal.nameAr || currentRedeemDeal.nameEn) : 
                currentLanguage === 'fr' ?
                (currentRedeemDeal.nameFr || currentRedeemDeal.nameEn) :
                currentRedeemDeal.nameEn;
            const storeName = currentLanguage === 'ar' ? 
                (currentRedeemDeal.storeNameAr || currentRedeemDeal.storeName) : 
                currentLanguage === 'fr' ?
                (currentRedeemDeal.storeNameFr || currentRedeemDeal.storeName) :
                currentRedeemDeal.storeName;
            
            document.getElementById('ratingDealNameMobile').textContent = dealName;
            document.getElementById('ratingStoreNameMobile').textContent = storeName;
            
            currentRating = 0;
            document.querySelectorAll('.rating-star-mobile').forEach(star => {
                star.classList.remove('active');
            });
            
            const ratingText = document.getElementById('ratingTextMobile');
            const ratingTextEn = ratingText.querySelector('.text-english');
            const ratingTextAr = ratingText.querySelector('.text-arabic');
            const ratingTextFr = ratingText.querySelector('.text-french');
            
            if (ratingTextEn && ratingTextAr && ratingTextFr) {
                ratingTextEn.textContent = 'Click on stars to rate';
                ratingTextAr.textContent = 'انقر على النجوم للتقييم';
                ratingTextFr.textContent = 'Cliquez sur les étoiles pour évaluer';
            }
            
            document.getElementById('customerNameMobile').value = currentUser ? currentUser.name : '';
            document.getElementById('ratingCommentMobile').value = '';
            
            document.getElementById('ratingErrorMessageMobile').classList.add('d-none');
            
            document.getElementById('ratingFormMobile').style.display = 'block';
            document.getElementById('ratingSuccessMobile').style.display = 'none';
            
            document.getElementById('ratingModalMobile').style.display = 'block';
        }
        
        function closeRatingModalMobile() {
            document.getElementById('ratingModalMobile').style.display = 'none';
        }
        
        function submitRatingMobile() {
            if (currentRating === 0) {
                showRatingErrorMobile(
                    currentLanguage === 'ar' ? 'الرجاء اختيار تقييم' : 
                    currentLanguage === 'fr' ? 'Veuillez sélectionner une évaluation' :
                    'Please select a rating'
                );
                return;
            }
            
            if (!currentRedeemDeal) return;
            
            const customerName = document.getElementById('customerNameMobile').value.trim() || 
                                (currentUser ? currentUser.name : 
                                (currentLanguage === 'ar' ? 'عميل' : 
                                 currentLanguage === 'fr' ? 'Client' :
                                 'Customer'));
            const comment = document.getElementById('ratingCommentMobile').value.trim();
            
            const review = {
                dealId: currentRedeemDeal.id,
                dealName: currentLanguage === 'ar' ? (currentRedeemDeal.nameAr || currentRedeemDeal.nameEn) : 
                         currentLanguage === 'fr' ? (currentRedeemDeal.nameFr || currentRedeemDeal.nameEn) :
                         currentRedeemDeal.nameEn,
                storeName: currentLanguage === 'ar' ? (currentRedeemDeal.storeNameAr || currentRedeemDeal.storeName) : 
                          currentLanguage === 'fr' ? (currentRedeemDeal.storeNameFr || currentRedeemDeal.storeName) :
                          currentRedeemDeal.storeName,
                customerId: currentUser ? currentUser.id : 'anonymous',
                customerName: customerName,
                customerEmail: currentUser ? currentUser.email : '',
                customerPhone: currentUser ? currentUser.phone : '',
                rating: currentRating,
                comment: comment,
                date: new Date().toISOString(),
                language: currentLanguage
            };
            
            if (db) {
                db.collection('reviews').add(review)
                    .then(() => {
                        console.log('Review saved to Firestore');
                        showRatingSuccess();
                    })
                    .catch((error) => {
                        console.error('Error saving review to Firestore:', error);
                        saveReviewToLocalStorage(review);
                        showRatingSuccess();
                    });
            } else {
                saveReviewToLocalStorage(review);
                showRatingSuccess();
            }
        }
        
        function showRatingSuccess() {
            const customerName = document.getElementById('customerNameMobile').value.trim() || 
                                (currentUser ? currentUser.name : 
                                (currentLanguage === 'ar' ? 'عميل' : 
                                 currentLanguage === 'fr' ? 'Client' :
                                 'Customer'));
            
            document.getElementById('ratingFormMobile').style.display = 'none';
            document.getElementById('ratingSuccessMobile').style.display = 'block';
            
            const successMessage = currentLanguage === 'ar' ?
                `شكراً لك ${customerName} على تقييمك!` :
                currentLanguage === 'fr' ?
                `Merci ${customerName} pour votre évaluation !` :
                `Thank you ${customerName} for your rating!`;
            
            document.getElementById('ratingSuccessMessageMobile').textContent = successMessage;
            
            setTimeout(() => {
                closeRatingModalMobile();
                closeRedeemModalMobile();
                showAlertMobile(languageTexts[currentLanguage].alerts.ratingSubmitted, 'success');
            }, 2000);
        }
        
        function showRatingErrorMobile(message) {
            const errorDiv = document.getElementById('ratingErrorMessageMobile');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.classList.remove('d-none');
            }
        }
        
        function saveReviewToLocalStorage(review) {
            const savedReviews = localStorage.getItem('aloottawa_reviews_mobile');
            let allReviews = savedReviews ? JSON.parse(savedReviews) : [];
            review.id = allReviews.length + 1;
            allReviews.push(review);
            localStorage.setItem('aloottawa_reviews_mobile', JSON.stringify(allReviews));
        }
        
        function setupMobileEventListeners() {
            const searchInput = document.getElementById('searchInputMobile');
            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        searchDealsMobile();
                    }
                });
            }
            
            const phoneInput = document.getElementById('signupPhoneMobile');
            if (phoneInput) {
                phoneInput.addEventListener('input', function(e) {
                    this.value = this.value.replace(/[^0-9]/g, '');
                });
            }
            
            document.querySelectorAll('.modal-mobile').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        const modalId = this.id;
                        if (modalId === 'loginModalMobile') closeLoginModalMobile();
                        if (modalId === 'redeemModalMobile') closeRedeemModalMobile();
                        if (modalId === 'ratingModalMobile') closeRatingModalMobile();
                        if (modalId === 'mapModalMobile') closeMapModalMobile();
                        if (modalId === 'profileModalMobile') closeProfileModalMobile();
                        if (modalId === 'mySavingsModalMobile') closeMySavingsModal();
                        if (modalId === 'subscriptionModalMobile') closeSubscriptionModal();
                        if (modalId === 'paymentMethodsModalMobile') closePaymentMethodsModal();
                    }
                });
            });
            
            document.querySelectorAll('.nav-item').forEach((item, index) => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    if (index === 0) showHome();
                    else if (index === 1) openMapModal();
                    else if (index === 2) showMyDeals();
                    else if (index === 3) showSaved();
                    else if (index === 4) showProfile();
                });
            });
            
            console.log('Event listeners setup complete');
        }
        
        function searchDealsMobile() {
            const searchTerm = document.getElementById('searchInputMobile').value.toLowerCase();
            
            if (searchTerm) {
                filteredDeals = allDeals.filter(deal => 
                    deal.nameEn.toLowerCase().includes(searchTerm) ||
                    (deal.nameAr && deal.nameAr.toLowerCase().includes(searchTerm)) ||
                    (deal.nameFr && deal.nameFr.toLowerCase().includes(searchTerm)) ||
                    deal.storeName.toLowerCase().includes(searchTerm) ||
                    (deal.storeNameAr && deal.storeNameAr.toLowerCase().includes(searchTerm)) ||
                    (deal.storeNameFr && deal.storeNameFr.toLowerCase().includes(searchTerm)) ||
                    deal.descriptionEn.toLowerCase().includes(searchTerm) ||
                    (deal.descriptionAr && deal.descriptionAr.toLowerCase().includes(searchTerm)) ||
                    (deal.descriptionFr && deal.descriptionFr.toLowerCase().includes(searchTerm)) ||
                    (deal.category === 'entertainment' && ('entertainment movies cinema bowling fun leisure').includes(searchTerm)) ||
                    (deal.category === 'selfcare' && ('selfcare spa massage beauty salon wellness relax').includes(searchTerm))
                );
            } else {
                filterDealsMobile(currentCategory);
            }
            
            displayDealsMobile();
        }
        
        function showDealDetails(dealId) {
            const deal = allDeals.find(d => String(d.id) === String(dealId));
            if (!deal) return;
            
            const dealName = currentLanguage === 'ar' ? (deal.nameAr || deal.nameEn) : 
                            currentLanguage === 'fr' ? (deal.nameFr || deal.nameEn) :
                            deal.nameEn;
            const storeName = currentLanguage === 'ar' ? (deal.storeNameAr || deal.storeName) : 
                             currentLanguage === 'fr' ? (deal.storeNameFr || deal.storeName) :
                             deal.storeName;
            const dealDescription = currentLanguage === 'ar' ? (deal.descriptionAr || deal.descriptionEn) : 
                                   currentLanguage === 'fr' ? (deal.descriptionFr || deal.descriptionEn) :
                                   deal.descriptionEn;
            const halalText = currentLanguage === 'ar' ? 'حلال' : 
                             currentLanguage === 'fr' ? 'Halal' :
                             'Halal';
            const redeemText = currentLanguage === 'ar' ? 'استبدال' : 
                              currentLanguage === 'fr' ? 'Utiliser' :
                              'Redeem';
            
            let categoryInfo = '';
            if (deal.category === 'entertainment') {
                categoryInfo = currentLanguage === 'ar' ? '🎬 ترفيه' : 
                              currentLanguage === 'fr' ? '🎬 Divertissement' : 
                              '🎬 Entertainment';
            } else if (deal.category === 'selfcare') {
                categoryInfo = currentLanguage === 'ar' ? '💆‍♀️ عناية ذاتية' : 
                              currentLanguage === 'fr' ? '💆‍♀️ Soins personnels' : 
                              '💆‍♀️ Self Care';
            }
            
            const detailsHTML = `
                <div class="deal-card-mobile" style="grid-column: 1 / -1;">
                    <div class="deal-badge">${deal.discount}% OFF</div>
                    
                    <div class="deal-image-container">
                        <img src="${deal.image}" alt="${dealName}" class="deal-image">
                    </div>
                    
                    <h5 class="deal-title">${dealName}</h5>
                    <div class="deal-store">
                        <i class="fas fa-store"></i> ${storeName}
                    </div>
                    
                    ${categoryInfo ? `<p class="text-info"><i class="fas fa-tag"></i> ${categoryInfo}</p>` : ''}
                    
                    <p class="deal-description">${dealDescription}</p>
                    
                    <div class="deal-price-container">
                        <div class="deal-price">
                            <span class="old-price">$${deal.oldPrice.toFixed(2)}</span>
                            <span class="new-price">$${deal.price.toFixed(2)}</span>
                        </div>
                    </div>
                    
                    ${deal.address ? `<p><i class="fas fa-map-marker-alt ${currentLanguage === 'ar' ? 'ms-2' : 'me-2'}"></i>${deal.address}</p>` : ''}
                    ${deal.halal ? `<span class="halal-badge"><i class="fas fa-check-circle"></i> ${halalText}</span>` : ''}
                    
                    <div class="deal-actions mt-3">
                        <button class="redeem-btn" onclick="openRedeemModalMobile('${deal.id}')">
                            <i class="fas fa-ticket-alt"></i> ${redeemText}
                        </button>
                        <button class="details-btn" onclick="openMapModal()">
                            <i class="fas fa-map"></i>
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('dealsContainerMobile').innerHTML = detailsHTML;
            document.getElementById('noDealsMessageMobile').style.display = 'none';
            document.getElementById('viewAllDealsBtn').style.display = 'none';
            
            showAlertMobile(
                currentLanguage === 'ar' ? 'يتم عرض تفاصيل العرض' : 
                currentLanguage === 'fr' ? 'Affichage des détails de l\'offre' :
                'Showing deal details',
                'info'
            );
        }
        
        function showHome() {
            currentCategory = 'all';
            dealsToShowLimit = 6;
            filterDealsMobile('all');
            updateNavActive('home');
            
            document.querySelector('.search-bar').style.display = 'block';
            document.querySelector('.location-section').style.display = 'block';
            document.querySelector('.categories-section').style.display = 'block';
            document.querySelector('.offers-section').style.display = 'block';
            document.querySelector('.offers-section .section-header').style.display = 'flex';
            
            loadDealsMobile();
            
            console.log('Home view loaded');
        }
        
        function updateNavActive(page) {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.classList.remove('active');
            });
            
            if (page === 'home') document.querySelector('.nav-item:nth-child(1)').classList.add('active');
            if (page === 'map') document.querySelector('.nav-item:nth-child(2)').classList.add('active');
            if (page === 'mydeals') document.querySelector('.nav-item:nth-child(3)').classList.add('active');
            if (page === 'saved') document.querySelector('.nav-item:nth-child(4)').classList.add('active');
            if (page === 'profile') document.querySelector('.nav-item:nth-child(5)').classList.add('active');
        }
        
        function showProfile() {
            if (!currentUser) {
                openLoginModal();
                return;
            }
            
            const initials = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
            document.getElementById('profileAvatarMobile').textContent = initials.substring(0, 2);
            document.getElementById('profileUserNameMobile').textContent = currentUser.name;
            document.getElementById('profileUserEmailMobile').textContent = currentUser.email || '';
            document.getElementById('profileUserPhoneMobile').textContent = currentUser.phone || '';
            
            if (currentUser.phoneVerified) {
                document.getElementById('profilePhoneVerified').style.display = 'inline-flex';
            } else {
                document.getElementById('profilePhoneVerified').style.display = 'none';
            }
            
            document.getElementById('profileModalMobile').style.display = 'block';
        }
        
        function closeProfileModalMobile() {
            document.getElementById('profileModalMobile').style.display = 'none';
        }
        
        function logoutUserMobile() {
            const confirmMessage = currentLanguage === 'ar' ? 
                'هل أنت متأكد من تسجيل الخروج؟' : 
                currentLanguage === 'fr' ?
                'Êtes-vous sûr de vouloir vous déconnecter ?' :
                'Are you sure you want to logout?';
            
            if (confirm(confirmMessage)) {
                if (auth) {
                    auth.signOut()
                        .then(() => {
                            showAlertMobile(languageTexts[currentLanguage].alerts.logoutSuccess, 'info');
                            closeProfileModalMobile();
                            
                            setTimeout(() => {
                                loadUserSavingsData();
                            }, 500);
                        })
                        .catch((error) => {
                            console.error('Logout error:', error);
                            showAlertMobile(
                                currentLanguage === 'ar' ? 'خطأ في تسجيل الخروج' : 
                                currentLanguage === 'fr' ? 'Erreur de déconnexion' :
                                'Logout error',
                                'danger'
                            );
                        });
                } else {
                    localStorage.removeItem('aloottawa_current_user');
                    sessionStorage.removeItem('aloottawa_current_user');
                    currentUser = null;
                    isSubscribed = false;
                    stripeCustomerId = null;
                    updateUserUIMobile();
                    updateSubscriptionUI();
                    showAlertMobile(languageTexts[currentLanguage].alerts.logoutSuccess, 'info');
                    closeProfileModalMobile();
                    
                    loadUserSavingsData();
                }
            }
        }
        
        function setupStorageSync() {
            window.addEventListener('storage', function(e) {
                if (e.key === 'aloottawa_deals') {
                    console.log('Deals updated in localStorage, refreshing...');
                    setTimeout(() => {
                        loadDealsMobile();
                        showAlertMobile(
                            languageTexts[currentLanguage].alerts.dealsSynced,
                            'info'
                        );
                    }, 500);
                }
                
                if (e.key === 'aloottawa_user_redemptions') {
                    console.log('Redemptions updated, refreshing savings data...');
                    loadUserSavingsData();
                }
            });
            
            setInterval(() => {
                const savedDeals = localStorage.getItem('aloottawa_deals');
                if (savedDeals) {
                    try {
                        const currentDeals = JSON.stringify(allDeals);
                        if (savedDeals !== currentDeals) {
                            console.log('Deals changed, refreshing...');
                            loadDealsMobile();
                        }
                    } catch (e) {
                        console.error('Error checking deals update:', e);
                    }
                }
            }, 5000);
        }
        
        function syncWithStoreDeals() {
            const syncBtn = document.querySelector('.sync-btn i');
            syncBtn.classList.add('syncing');
            
            showLoading(true);
            
            setTimeout(() => {
                loadDealsMobile();
                syncBtn.classList.remove('syncing');
                
                showAlertMobile(
                    languageTexts[currentLanguage].alerts.dealsSynced,
                    'success'
                );
            }, 500);
        }
        
        function viewAllDeals() {
            dealsToShowLimit = filteredDeals.length;
            displayDealsMobile();
            
            document.getElementById('viewAllDealsBtn').style.display = 'none';
            
            showAlertMobile(
                currentLanguage === 'ar' ? 'يتم عرض جميع العروض' : 
                currentLanguage === 'fr' ? 'Affichage de toutes les offres' :
                'Showing all deals',
                'info'
            );
        }
        
        function showMap() {
            openMapModal();
        }
        
        function showMyDeals() {
            if (!currentUser) {
                openLoginModal();
                return;
            }
            
            updateNavActive('mydeals');
            openMySavingsModal();
        }
        
        function showSaved() {
            if (!currentUser) {
                openLoginModal();
                return;
            }
            
            updateNavActive('saved');
            showAlertMobile(
                currentLanguage === 'ar' ? 'ميزة المحفوظة قريباً!' : 
                currentLanguage === 'fr' ? 'Fonctionnalité Enregistrées bientôt disponible !' :
                'Saved feature coming soon!',
                'info'
            );
        }
        
        function viewMyRedemptionsMobile() {
            openMySavingsModal();
            closeProfileModalMobile();
        }
        
        function viewSavedDealsMobile() {
            showSaved();
            closeProfileModalMobile();
        }
        
        function viewMyReviewsMobile() {
            showAlertMobile(
                currentLanguage === 'ar' ? 'ميزة التقييمات قريباً!' : 
                currentLanguage === 'fr' ? 'Fonctionnalité Mes avis bientôt disponible !' :
                'My Reviews feature coming soon!',
                'info'
            );
            closeProfileModalMobile();
        }
        
        function viewSettingsMobile() {
            showAlertMobile(
                currentLanguage === 'ar' ? 'ميزة الإعدادات قريباً!' : 
                currentLanguage === 'fr' ? 'Fonctionnalité Paramètres bientôt disponible !' :
                'Settings feature coming soon!',
                'info'
            );
            closeProfileModalMobile();
        }
        
        // Phone verification functions (placeholders)
        function showPhoneLoginTabMobile() {
            document.getElementById('loginTabMobile').style.display = 'none';
            document.getElementById('signupTabMobile').style.display = 'none';
            document.getElementById('forgotPasswordTabMobile').style.display = 'none';
            document.getElementById('phoneLoginTabMobile').style.display = 'block';
        }
        
        function sendPhoneOTPMobile() {
            showAlertMobile(
                currentLanguage === 'ar' ? 'خدمة التحقق بالهاتف غير مفعلة في العرض التوضيحي' : 
                currentLanguage === 'fr' ? 'Service de vérification téléphonique non activé dans la démo' :
                'Phone verification service not enabled in demo',
                'info'
            );
        }
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', initMobileApp);
    </script>
</body>
</html>
